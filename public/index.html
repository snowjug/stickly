<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#0071e3" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0a84ff" media="(prefers-color-scheme: dark)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Stickly">
    <title>Stickly - Share Your Thoughts Anonymously</title>
    <link rel="stylesheet" href="style.css">
    <script defer src="https://cdn.vercel-insights.com/v1/script.js"></script>
</head>
<body>
    <!-- Custom Cursor -->
    <div class="cursor-dot"></div>
    <div class="cursor-shadow"></div>
    
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand" onclick="showAdminLogin()" style="cursor: pointer;" title="Admin Access">
            <span class="logo">üí¨</span>
            <div>
                <h1>Stickly</h1>
                <p class="tagline">Your secrets are safe here</p>
            </div>
        </div>
        <div class="nav-links">
            <button class="nav-btn active" data-section="all" onclick="switchSection('all')">
                <span class="nav-emoji">üì•</span>
                <span class="nav-label">All</span>
            </button>
            <button class="nav-btn" data-section="whistleblower" onclick="switchSection('whistleblower')">
                <span class="nav-emoji">üîì</span>
                <span class="nav-label">Whistleblower</span>
            </button>
            <button class="nav-btn" data-section="controversy" onclick="switchSection('controversy')">
                <span class="nav-emoji">‚ö°</span>
                <span class="nav-label">Controversy</span>
            </button>
            <button class="nav-btn" data-section="thoughts" onclick="switchSection('thoughts')">
                <span class="nav-emoji">üí≠</span>
                <span class="nav-label">Thoughts</span>
            </button>
            <button class="nav-btn" data-section="confessions" onclick="switchSection('confessions')">
                <span class="nav-emoji">ü§´</span>
                <span class="nav-label">Confessions</span>
            </button>
        </div>
        <div style="grid-area: actions; display: flex; gap: 0.75rem; align-items: center; justify-content: flex-end; flex-wrap: nowrap;">
            <div class="search-container" style="margin: 0;">
                <input type="text" id="searchInput" placeholder="üîç Search messages..." oninput="filterMessages()">
            </div>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">
                <span id="darkModeIcon">üåô</span>
            </button>
            <button class="profile-toggle" id="profileBtn" onclick="toggleProfileModal()" title="Profile Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="10" r="3"></circle><path d="M6.168 18.849A4 4 0 0 1 10 16h4a4 4 0 0 1 3.834 2.855"></path></svg>
            </button>
        </div>
    </nav>

    <!-- Floating Action Button -->
    <button class="fab" onclick="toggleModal()">
        <span class="fab-icon">+</span>
        <span class="fab-label">Post Message</span>
    </button>

    <!-- Post Message Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share a Message</h2>
                <button class="close-btn" onclick="toggleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="category-selector">
                    <label>Choose a category:</label>
                    <div class="category-buttons">
                        <button class="category-btn" data-category="whistleblower" onclick="selectCategory('whistleblower')">
                            <span class="emoji">üîì</span>
                            <span>Whistleblower</span>
                        </button>
                        <button class="category-btn" data-category="controversy" onclick="selectCategory('controversy')">
                            <span class="emoji">‚ö°</span>
                            <span>Controversy</span>
                        </button>
                        <button class="category-btn active" data-category="thoughts" onclick="selectCategory('thoughts')">
                            <span class="emoji">üí≠</span>
                            <span>Thoughts</span>
                        </button>
                        <button class="category-btn" data-category="confessions" onclick="selectCategory('confessions')">
                            <span class="emoji">ü§´</span>
                            <span>Confessions</span>
                        </button>
                        <button class="category-btn" data-category="others" onclick="selectCategory('others')">
                            <span class="emoji">üìå</span>
                            <span>Others</span>
                        </button>
                    </div>
                </div>
                <textarea 
                    id="messageInput" 
                    placeholder="What's on your mind?"
                    maxlength="500"
                ></textarea>
                <div class="image-upload-section">
                    <label for="imageUpload" class="image-upload-label">
                        <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                        </svg>
                        <span class="upload-text">Attach Image or GIF</span>
                    </label>
                    <input 
                        type="file" 
                        id="imageUpload" 
                        accept="image/jpeg,image/jpg,image/gif,image/png"
                        style="display: none;"
                    />
                    <div style="text-align: center; margin: 0.5rem 0; color: var(--subtle-text-color); font-size: 0.9rem;">or</div>
                    <input 
                        type="url" 
                        id="imageUrl" 
                        placeholder="Paste image/GIF URL"
                        class="admin-input"
                        style="margin-bottom: 0.5rem;"
                    />
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                <div class="form-footer">
                    <span class="char-count">0/500</span>
                    <button class="post-btn" onclick="postMessage()">Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="adminModalTitle">Admin Login</h2>
                <button class="close-btn" onclick="toggleAdminModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="adminLoginForm">
                    <input 
                        type="text" 
                        id="adminUsername" 
                        placeholder="Username"
                        class="admin-input"
                    />
                    <input 
                        type="password" 
                        id="adminPassword" 
                        placeholder="Password"
                        class="admin-input"
                    />
                    <button class="post-btn" onclick="adminLogin()" style="width: 100%; margin-top: 1rem;">Login</button>
                </div>
                <div id="adminPanel" style="display: none;">
                    <p style="text-align: center; color: var(--text-color); margin-bottom: 1rem;">‚úÖ Logged in as Admin</p>
                    <button class="post-btn" onclick="adminLogout()" style="width: 100%; background: #ff4444;">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üë§ Profile Settings</h2>
                <button class="close-btn" onclick="toggleProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.75rem; color: var(--text-color); font-weight: 600; font-size: 1rem;">Username</label>
                    <div style="position: relative;">
                        <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--accent-color); font-weight: 700; font-size: 1.1rem; z-index: 1;">@</span>
                        <input type="text" id="usernameInput" class="admin-input" placeholder="username" maxlength="20" value="" style="padding-left: 2.5rem;">
                    </div>
                    <small style="display: block; margin-top: 0.5rem; color: var(--subtle-text-color); font-size: 0.85rem;">‚ú® Max 20 characters ‚Ä¢ No spaces allowed</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.75rem; color: var(--text-color); font-weight: 600; font-size: 1rem;">Choose Your Avatar</label>
                    <div id="avatarGrid" class="avatar-grid">
                        <!-- Avatars will be generated here -->
                    </div>
                    <button class="secondary-btn" onclick="regenerateAvatars()" style="width: 100%; margin-top: 1rem;">
                        üé≤ Shuffle Avatars
                    </button>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(0,113,227,0.08), rgba(10,132,255,0.08)); border-radius: 12px; border: 2px solid rgba(0,113,227,0.2); box-shadow: 0 4px 12px rgba(0,113,227,0.1);">
                    <p style="margin: 0 0 0.75rem 0; color: var(--text-color); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7;">Preview</p>
                    <div id="profilePreview" style="display: flex; align-items: center; gap: 0.75rem;">
                        <span class="message-avatar">üë§</span>
                        <span style="font-weight: 700; font-size: 1.05rem; color: var(--text-color); display: flex; align-items: center;"><span style="color: var(--accent-color); margin-right: 2px;">@</span>Anonymous</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.75rem;">
                    <button class="post-btn" onclick="saveUserProfile()" style="flex: 1;">üíæ Save Profile</button>
                    <button class="cancel-btn" onclick="toggleProfileModal()" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="main-container">
        <div class="section-header">
            <h2 id="sectionTitle">All Messages</h2>
            <p id="sectionSubtitle">Anonymous messages from around the world</p>
        </div>
        <div id="messagesList"></div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Report Message</h2>
                <button class="close-btn" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-color);">Why are you reporting this message?</p>
                <select id="reportReason" class="admin-input" style="margin-bottom: 1rem;">
                    <option value="">Select a reason...</option>
                    <option value="spam">Spam</option>
                    <option value="harassment">Harassment or bullying</option>
                    <option value="hate">Hate speech</option>
                    <option value="violence">Violence or threats</option>
                    <option value="inappropriate">Inappropriate content</option>
                    <option value="other">Other</option>
                </select>
                <button class="post-btn" onclick="submitReport()" style="width: 100%;">Submit Report</button>
                <button class="cancel-btn" onclick="closeReportModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="" alt="Full size image">
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Made for Chaos by Atharv & Ankit</p>
    </footer>

    <script>
        let currentSection = 'all';
        let selectedCategory = 'thoughts';
        let adminSessionId = localStorage.getItem('adminSessionId') || null;

        // Admin functions
        function toggleAdminModal() {
            const modal = document.getElementById('adminModal');
            modal.classList.toggle('show');
            checkAdminStatus();
        }

        async function checkAdminStatus() {
            const adminBtn = document.getElementById('adminBtn');
            const loginForm = document.getElementById('adminLoginForm');
            const adminPanel = document.getElementById('adminPanel');
            
            if (!adminSessionId) {
                adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
                loginForm.style.display = 'block';
                adminPanel.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/admin/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });
                const data = await response.json();
                
                if (data.isAdmin) {
                    adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>';
                    adminBtn.style.background = 'linear-gradient(135deg, #0071e3, #0077ed)';
                    adminBtn.style.color = 'white';
                    loginForm.style.display = 'none';
                    adminPanel.style.display = 'block';
                } else {
                    adminSessionId = null;
                    localStorage.removeItem('adminSessionId');
                    adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
                    adminBtn.style.background = '';
                    adminBtn.style.color = '';
                    loginForm.style.display = 'block';
                    adminPanel.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    adminSessionId = data.sessionId;
                    localStorage.setItem('adminSessionId', adminSessionId);
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminPassword').value = '';
                    toggleAdminModal();
                    checkAdminStatus();
                    loadMessages();
                } else {
                    alert('Invalid credentials');
                }
            } catch (error) {
                console.error('Error logging in:', error);
                alert('Error logging in');
            }
        }

        async function adminLogout() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });
                
                adminSessionId = null;
                localStorage.removeItem('adminSessionId');
                toggleAdminModal();
                checkAdminStatus();
                loadMessages();
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Profile functions
        const AVATAR_EMOJIS = ['üòÄ', 'üòé', 'ü§ì', 'üò∫', 'üê∂', 'ü¶ä', 'üêº', 'ü¶Å', 'üê∏', 'ü¶Ñ', 'üåü', '‚ö°', 'üî•', 'üíé', 'üé®', 'üé≠', 'üé™', 'üéØ', 'üé≤', 'üé∏', 'üöÄ', 'üåà', 'üå∏', 'üçï', 'üçî', 'üç©', 'üéÇ', '‚òï', 'üåç', 'üèÜ'];

        function getUserProfile() {
            const username = sessionStorage.getItem('userUsername') || 'Anonymous';
            const avatar = sessionStorage.getItem('userAvatar') || 'üë§';
            return { username, avatar };
        }

        function showAdminLogin() {
            toggleAdminModal();
        }

        function toggleProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.toggle('show');
            
            if (modal.classList.contains('show')) {
                const profile = getUserProfile();
                document.getElementById('usernameInput').value = profile.username === 'Anonymous' ? '' : profile.username;
                generateAvatars(profile.avatar);
                updateProfilePreview();
            }
        }

        function generateAvatars(selectedAvatar = null) {
            const avatarGrid = document.getElementById('avatarGrid');
            const shuffled = [...AVATAR_EMOJIS].sort(() => Math.random() - 0.5);
            const avatars = shuffled.slice(0, 12);
            
            // If there's a selected avatar, make sure it's in the grid
            if (selectedAvatar && !avatars.includes(selectedAvatar)) {
                avatars[0] = selectedAvatar;
            }
            
            avatarGrid.innerHTML = avatars.map(emoji => `
                <div class="avatar-option ${emoji === selectedAvatar ? 'selected' : ''}" 
                     data-avatar="${emoji}" 
                     onclick="selectAvatar('${emoji}')">
                    ${emoji}
                </div>
            `).join('');
        }

        function regenerateAvatars() {
            const profile = getUserProfile();
            generateAvatars(profile.avatar);
        }

        function selectAvatar(emoji) {
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            updateProfilePreview();
        }

        function updateProfilePreview() {
            let username = document.getElementById('usernameInput').value.trim().replace(/\s+/g, '') || 'Anonymous';
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const avatar = selectedAvatar ? selectedAvatar.dataset.avatar : 'üë§';
            
            document.getElementById('profilePreview').innerHTML = `
                <span class="message-avatar">${avatar}</span>
                <span style="font-weight: 700; font-size: 1.05rem; color: var(--text-color); display: flex; align-items: center;"><span style="color: var(--accent-color); margin-right: 2px;">@</span>${username}</span>
            `;
        }

        function saveUserProfile() {
            let username = document.getElementById('usernameInput').value.trim().replace(/\s+/g, '') || 'Anonymous';
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const avatar = selectedAvatar ? selectedAvatar.dataset.avatar : 'üë§';
            
            // Remove any @ symbols user might have typed
            username = username.replace(/@/g, '');
            
            sessionStorage.setItem('userUsername', username);
            sessionStorage.setItem('userAvatar', avatar);
            
            // Show success animation
            const modal = document.getElementById('profileModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.animation = 'pulse 0.3s ease';
            
            setTimeout(() => {
                toggleProfileModal();
                modalContent.style.animation = '';
            }, 300);
        }

        // Update username input live preview
        document.addEventListener('DOMContentLoaded', () => {
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.addEventListener('input', (e) => {
                    // Remove spaces and @ symbols as user types
                    e.target.value = e.target.value.replace(/[\s@]/g, '');
                    updateProfilePreview();
                });
            }
        });

        // Image upload preview
        function initImageUpload() {
            const imageUpload = document.getElementById('imageUpload');
            const imageUrl = document.getElementById('imageUrl');
            const imagePreview = document.getElementById('imagePreview');
            
            if (!imageUpload) return;
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('Image selected:', file.name, file.type);
                    imageUrl.value = ''; // Clear URL input
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.innerHTML = `
                            <div class="preview-container">
                                <img src="${e.target.result}" alt="Preview" />
                                <button class="remove-image" onclick="removeImage()">√ó</button>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle URL input
            if (imageUrl) {
                imageUrl.addEventListener('input', (e) => {
                    const url = e.target.value.trim();
                    if (url) {
                        imageUpload.value = ''; // Clear file upload
                        imagePreview.innerHTML = `
                            <div class="preview-container">
                                <img src="${url}" alt="Preview" onerror="this.parentElement.innerHTML='<p style=\"color: var(--subtle-text-color); text-align: center;\">Invalid image URL</p>';" />
                                <button class="remove-image" onclick="removeImage()">√ó</button>
                            </div>
                        `;
                    } else {
                        imagePreview.innerHTML = '';
                    }
                });
            }
        }

        function removeImage() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('imageUrl').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }

        // Load messages when page loads
        window.onload = () => {
            loadMessages();
            updateCharCount();
            initDarkMode();
            initFAB();
            initImageUpload();
            checkAdminStatus();
        };

        // FAB collapse functionality
        function initFAB() {
            const fab = document.querySelector('.fab');
            let timeout;

            // Auto-collapse after 3 seconds
            timeout = setTimeout(() => {
                fab.classList.add('collapsed');
            }, 3000);

            // Expand on hover
            fab.addEventListener('mouseenter', () => {
                clearTimeout(timeout);
                fab.classList.remove('collapsed');
            });

            // Collapse after leaving
            fab.addEventListener('mouseleave', () => {
                timeout = setTimeout(() => {
                    fab.classList.add('collapsed');
                }, 1000);
            });
        }

        // Dark mode functionality
        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Update character count
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', updateCharCount);

        function updateCharCount() {
            const count = messageInput.value.length;
            document.querySelector('.char-count').textContent = `${count}/500`;
        }

        // Switch section
        function switchSection(section) {
            currentSection = section;
            searchQuery = ''; // Reset search when switching sections
            document.getElementById('searchInput').value = '';
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === section);
            });

            const titles = {
                'all': { title: 'All Messages', subtitle: 'Anonymous messages from around the world' },
                'whistleblower': { title: 'Whistleblower', subtitle: 'Reveal the truth - Expose scams, corruption, and company secrets' },
                'controversy': { title: 'Controversy', subtitle: 'Hot takes and heated debates' },
                'thoughts': { title: 'Thoughts', subtitle: 'Random thoughts and musings' },
                'confessions': { title: 'Confessions', subtitle: 'Anonymous secrets and stories' }
            };

            document.getElementById('sectionTitle').textContent = titles[section].title;
            document.getElementById('sectionSubtitle').textContent = titles[section].subtitle;

            // Trigger section-specific effects
            if (section === 'whistleblower') {
                createMatrixRain();
            } else if (section === 'controversy') {
                createLightningBolts();
            } else if (section === 'thoughts') {
                createThoughtBubbles();
            } else if (section === 'confessions') {
                createWhisperBubbles();
            }

            loadMessages();
        }

        // Toggle modal
        function toggleModal() {
            const modal = document.getElementById('postModal');
            const isClosing = modal.classList.contains('show');
            
            if (isClosing) {
                // Clear inputs when closing modal
                messageInput.value = '';
                const imageUpload = document.getElementById('imageUpload');
                const imageUrl = document.getElementById('imageUrl');
                if (imageUpload) {
                    imageUpload.value = '';
                    imageUrl.value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                }
                updateCharCount();
            }
            
            modal.classList.toggle('show');
        }

        // Select category
        function selectCategory(category) {
            selectedCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
        }

        // Load messages
        async function loadMessages() {
            try {
                const url = currentSection === 'all' 
                    ? '/api/messages' 
                    : `/api/messages?category=${currentSection}`;
                
                const response = await fetch(url);
                const messages = await response.json();
                allMessages = messages; // Store for filtering
                displayMessages(messages);
                updateMessageCounts();
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Post a new message
        async function postMessage() {
            const messageText = messageInput.value.trim();
            const imageUpload = document.getElementById('imageUpload');
            const imageUrl = document.getElementById('imageUrl');
            const modalContent = document.querySelector('.modal-content');
            
            // Allow posting if either message, file, or URL is present
            if (!messageText && (!imageUpload || !imageUpload.files[0]) && (!imageUrl || !imageUrl.value.trim())) {
                modalContent.classList.add('shake');
                setTimeout(() => modalContent.classList.remove('shake'), 400);
                return;
            }

            try {
                const formData = new FormData();
                formData.append('message', messageText || '');
                formData.append('category', selectedCategory);
                
                // Get user profile with default anonymous values
                const profile = getUserProfile();
                formData.append('username', profile.username);
                formData.append('avatar', profile.avatar);
                
                if (imageUpload && imageUpload.files[0]) {
                    console.log('Uploading image:', imageUpload.files[0].name);
                    formData.append('image', imageUpload.files[0]);
                } else if (imageUrl && imageUrl.value.trim()) {
                    console.log('Using image URL:', imageUrl.value.trim());
                    formData.append('imageUrl', imageUrl.value.trim());
                }

                const response = await fetch('/api/messages', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Message posted successfully:', result);
                    messageInput.value = '';
                    if (imageUpload) {
                        imageUpload.value = '';
                        imageUrl.value = '';
                        document.getElementById('imagePreview').innerHTML = '';
                    }
                    updateCharCount();
                    toggleModal();
                    createConfetti();
                    
                    // Auto jump to "All" section to see the new post
                    switchSection('all');
                } else {
                    const error = await response.json();
                    console.error('Error response:', error);
                    alert('Error posting message. Please try again.');
                }
            } catch (error) {
                console.error('Error posting message:', error);
                alert('Error posting message. Please try again.');
            }
        }

        // Display messages as cards
        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            
            // Filter by search query if present
            let filteredMessages = messages;
            if (searchQuery) {
                filteredMessages = messages.filter(msg => 
                    msg.text.toLowerCase().includes(searchQuery) ||
                    msg.category.toLowerCase().includes(searchQuery)
                );
            }
            
            if (filteredMessages.length === 0) {
                const noMsgText = searchQuery 
                    ? `No messages found matching "${searchQuery}"`
                    : 'No messages in this category yet. Be the first to share!';
                messagesList.innerHTML = `<div class="no-messages">${noMsgText}</div>`;
                return;
            }

            const containerWidth = messagesList.offsetWidth || 1200;
            const cardWidth = 300;
            const gap = 40;
            const cardsPerRow = Math.floor(containerWidth / (cardWidth + gap));

            const categoryEmojis = {
                'whistleblower': 'üîì',
                'controversy': '‚ö°',
                'thoughts': 'üí≠',
                'confessions': 'ü§´',
                'others': 'üìå'
            };

            const fragment = document.createDocumentFragment();
            const totalRows = Math.ceil(filteredMessages.length / cardsPerRow);

            filteredMessages.forEach((msg, index) => {
                const timeAgo = getTimeAgo(new Date(msg.timestamp));
                const row = Math.floor(index / cardsPerRow);
                const col = index % cardsPerRow;
                const left = col * (cardWidth + gap);
                const top = row * (cardWidth + gap);

                const card = document.createElement('div');
                card.className = 'message-card';
                card.setAttribute('data-category', msg.category);
                card.style.cssText = `left: ${left}px; top: ${top}px; animation-delay: ${index * 0.05}s; width: ${cardWidth}px;`;
                
                const isLiked = likedMessages.includes(msg.id);
                const likesCount = msg.likes || 0;
                
                const username = msg.username || 'Anonymous';
                const avatar = msg.avatar || 'üë§';
                
                card.innerHTML = `
                    <div class="message-header">
                        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                            <span class="message-avatar">${avatar}</span>
                            <div style="display: flex; flex-direction: column;">
                                <span class="message-username">${escapeHtml(username)}</span>
                                <span class="category-badge" style="margin-top: 0.25rem;">${categoryEmojis[msg.category]} ${msg.category}</span>
                            </div>
                        </div>
                        <div class="message-actions">
                            <span class="message-time">${timeAgo}</span>
                            <button class="delete-btn" onclick="deleteMessage(${msg.id})" title="Delete message">√ó</button>
                        </div>
                    </div>
                    <p class="message-text">${escapeHtml(msg.text)}</p>
                    ${msg.image ? `<img src="${msg.image}" alt="Attached image" class="message-image" onclick="openImageModal('${msg.image}')" />` : ''}
                    <div class="message-footer">
                        <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(${msg.id}, event)" title="Like this message">
                            <span class="heart-icon">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                            <span class="like-count">${likesCount}</span>
                        </button>
                        <button class="share-btn" onclick="shareMessage(${msg.id}, event)" title="Share this message">üîó</button>
                        <button class="report-btn" onclick="openReportModal(${msg.id}, event)" title="Report this message">üö©</button>
                    </div>
                `;
                
                fragment.appendChild(card);
            });

            messagesList.innerHTML = '';
            messagesList.appendChild(fragment);
            messagesList.style.minHeight = (totalRows * (cardWidth + gap)) + 'px';

            // Add effects
            addTiltEffect();
            document.querySelectorAll('.message-card').forEach(makeDraggable);
        }

        // Confetti animation
        function createConfetti() {
            const colors = ['#FF6B6B', '#FF9F43', '#95E1D3', '#F38181', '#A29BFE', '#6BCF7F'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = (Math.random() * 10 + 5) + 'px';
                    confetti.style.opacity = '1';
                    confetti.style.animation = `confetti-fall ${Math.random() * 2 + 2}s linear forwards`;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        // Matrix Rain Effect for Whistleblower section
        function createMatrixRain() {
            const chars = '01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
            const drops = 30;
            
            for (let i = 0; i < drops; i++) {
                setTimeout(() => {
                    const matrixChar = document.createElement('div');
                    matrixChar.className = 'matrix-char';
                    matrixChar.textContent = chars[Math.floor(Math.random() * chars.length)];
                    matrixChar.style.left = Math.random() * 100 + '%';
                    matrixChar.style.top = '-20px';
                    
                    const duration = Math.random() * 1 + 1.5; // 1.5-2.5 seconds
                    matrixChar.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(matrixChar);
                    
                    // Remove after animation
                    setTimeout(() => matrixChar.remove(), duration * 1000);
                }, i * 50);
            }
        }

        // Sparkles Effect for Inspiration section
        function createSparkles() {
            const sparkleChars = ['‚ú®', '‚≠ê', 'üí´', 'üåü', '‚ú¥Ô∏è'];
            const count = 25;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.textContent = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.top = Math.random() * 100 + '%';
                    sparkle.style.fontSize = (Math.random() * 20 + 15) + 'px';
                    
                    const duration = Math.random() * 1 + 1;
                    sparkle.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), duration * 1000);
                }, i * 40);
            }
        }

        // Floating Books Effect for Knowledge section
        function createFloatingBooks() {
            const bookEmojis = ['üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ'];
            const count = 20;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const book = document.createElement('div');
                    book.className = 'floating-book';
                    book.textContent = bookEmojis[Math.floor(Math.random() * bookEmojis.length)];
                    book.style.left = Math.random() * 100 + '%';
                    book.style.bottom = '-50px';
                    
                    const duration = Math.random() * 1 + 1;
                    book.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(book);
                    setTimeout(() => book.remove(), duration * 1000);
                }, i * 60);
            }
        }

        // Thought Bubbles Effect for Thoughts section
        function createThoughtBubbles() {
            const count = 15;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const bubble = document.createElement('div');
                    bubble.className = 'thought-bubble';
                    const size = Math.random() * 40 + 20;
                    bubble.style.width = size + 'px';
                    bubble.style.height = size + 'px';
                    bubble.style.left = Math.random() * 100 + '%';
                    bubble.style.bottom = '-50px';
                    
                    const duration = Math.random() * 0.7 + 0.8;
                    bubble.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(bubble);
                    setTimeout(() => bubble.remove(), duration * 1000);
                }, i * 80);
            }
        }

        // Floating Hearts Effect for Confessions section
        function createWhisperBubbles() {
            const whisperEmojis = ['üí¨', 'üó®Ô∏è', 'üí≠', 'ü§ê', 'ü§´'];
            const count = 25;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'floating-heart';
                    heart.textContent = whisperEmojis[Math.floor(Math.random() * whisperEmojis.length)];
                    heart.style.left = Math.random() * 100 + '%';
                    heart.style.bottom = '-50px';
                    
                    const duration = Math.random() * 1.2 + 1.5;
                    heart.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(heart);
                    setTimeout(() => heart.remove(), duration * 1000);
                }, i * 60);
            }
        }

        // Lightning Bolts Effect for Controversy section
        function createLightningBolts() {
            const count = 18;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const lightning = document.createElement('div');
                    lightning.className = 'floating-lightning';
                    lightning.textContent = '‚ö°';
                    lightning.style.left = Math.random() * 100 + '%';
                    lightning.style.top = '-50px';
                    
                    const duration = Math.random() * 0.6 + 0.9;
                    lightning.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(lightning);
                    setTimeout(() => lightning.remove(), duration * 1000);
                }, i * 70);
            }
        }

        // 3D tilt effect on hover
        function addTiltEffect() {
            const cards = document.querySelectorAll('.message-card');
            
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const rotateX = (y - centerY) / 10;
                    const rotateY = (centerX - x) / 10;
                    
                    card.style.setProperty('--rotate-x', `${rotateX}deg`);
                    card.style.setProperty('--rotate-y', `${rotateY}deg`);
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.setProperty('--rotate-x', '0deg');
                    card.style.setProperty('--rotate-y', '0deg');
                });
            });
        }

        // Calculate time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imageSrc;
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imageSrc;
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('postModal');
            if (event.target === modal) {
                toggleModal();
            }
        };

        // Allow posting with Ctrl+Enter
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                postMessage();
            }
        });

        // Delete message
        async function deleteMessage(messageId) {
            if (!adminSessionId) {
                alert('Admin login required to delete messages');
                toggleAdminModal();
                return;
            }
            
            if (!confirm('Delete this message?')) return;
            
            try {
                const response = await fetch(`/api/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });

                if (response.ok) {
                    loadMessages();
                } else if (response.status === 403) {
                    alert('Unauthorized. Please login as admin.');
                    adminSessionId = null;
                    localStorage.removeItem('adminSessionId');
                    checkAdminStatus();
                    toggleAdminModal();
                } else {
                    alert('Error deleting message. Please try again.');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            }
        }

        // Custom Cursor (optimized with RAF)
        const cursorDot = document.querySelector('.cursor-dot');
        let mouseX = 0, mouseY = 0;

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            cursorDot.style.left = mouseX + 'px';
            cursorDot.style.top = mouseY + 'px';
        });

        // Draggable message cards (optimized)
        let isDragging = false;
        let draggedCard = null;
        let offsetX = 0;
        let offsetY = 0;

        function makeDraggable(card) {
            card.addEventListener('mousedown', startDrag);
        }

        function startDrag(e) {
            if (e.target.tagName === 'A' || e.target.closest('a')) return;
            
            isDragging = true;
            draggedCard = e.currentTarget;
            draggedCard.classList.add('dragging');
            
            const rect = draggedCard.getBoundingClientRect();
            const container = document.getElementById('messagesList').getBoundingClientRect();
            
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            e.preventDefault();
        }

        function onMouseMove(e) {
            if (!isDragging || !draggedCard) return;
            
            const container = document.getElementById('messagesList');
            const containerRect = container.getBoundingClientRect();
            
            let newX = e.clientX - containerRect.left - offsetX;
            let newY = e.clientY - containerRect.top - offsetY;
            
            // Keep within container bounds
            newX = Math.max(0, Math.min(newX, containerRect.width - draggedCard.offsetWidth));
            newY = Math.max(0, Math.min(newY, containerRect.height - draggedCard.offsetHeight));
            
            draggedCard.style.left = newX + 'px';
            draggedCard.style.top = newY + 'px';
        }

        function onMouseUp() {
            if (isDragging && draggedCard) {
                draggedCard.classList.remove('dragging');
                isDragging = false;
                draggedCard = null;
            }
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);

        // Like/Unlike functionality
        let likedMessages = JSON.parse(localStorage.getItem('likedMessages') || '[]');

        async function toggleLike(messageId, event) {
            event.stopPropagation();
            const isLiked = likedMessages.includes(messageId);
            
            try {
                const endpoint = isLiked ? 'unlike' : 'like';
                const response = await fetch(`/api/messages/${messageId}/${endpoint}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update localStorage
                    if (isLiked) {
                        likedMessages = likedMessages.filter(id => id !== messageId);
                    } else {
                        likedMessages.push(messageId);
                    }
                    localStorage.setItem('likedMessages', JSON.stringify(likedMessages));
                    
                    // Update UI
                    const likeBtn = event.target.closest('.like-btn');
                    const countSpan = likeBtn.querySelector('.like-count');
                    countSpan.textContent = data.likes;
                    likeBtn.classList.toggle('liked', !isLiked);
                    
                    // Animate
                    likeBtn.style.transform = 'scale(1.2)';
                    setTimeout(() => likeBtn.style.transform = '', 200);
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        // Report functionality
        let currentReportMessageId = null;

        function openReportModal(messageId, event) {
            event.stopPropagation();
            currentReportMessageId = messageId;
            document.getElementById('reportModal').classList.add('show');
            document.getElementById('reportReason').value = '';
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
            currentReportMessageId = null;
        }

        async function submitReport() {
            const reason = document.getElementById('reportReason').value;
            
            if (!reason) {
                alert('Please select a reason for reporting');
                return;
            }
            
            try {
                const response = await fetch(`/api/messages/${currentReportMessageId}/report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    closeReportModal();
                    alert('Thank you for your report. We will review this message.');
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('Error submitting report');
            }
        }

        // Search/Filter functionality
        let searchQuery = '';
        let allMessages = [];

        function filterMessages() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            displayMessages(allMessages);
        }

        // Update message counts
        async function updateMessageCounts() {
            // Counts removed - function kept for compatibility
            return;
        }

        // Share message as image
        async function shareMessage(messageId, event) {
            event.stopPropagation();
            
            const card = event.target.closest('.message-card');
            const shareBtn = card.querySelector('.share-btn');
            
            // Use modern Web Share API if available
            if (navigator.share) {
                try {
                    const message = allMessages.find(m => m.id === messageId);
                    await navigator.share({
                        title: 'Stickly Message',
                        text: message.text || 'Check out this message!',
                        url: window.location.href
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Error sharing:', error);
                    }
                }
            } else {
                // Fallback: Copy to clipboard
                const message = allMessages.find(m => m.id === messageId);
                const text = `${message.text}\n\n- Shared from Stickly`;
                
                navigator.clipboard.writeText(text).then(() => {
                    shareBtn.innerHTML = '‚úì';
                    setTimeout(() => shareBtn.innerHTML = 'üîó', 1500);
                }).catch(err => {
                    console.error('Error copying:', err);
                    alert('Share failed. Please try again.');
                });
            }
        }
    </script>
</body>
</html>
