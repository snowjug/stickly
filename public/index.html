<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#0071e3" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0a84ff" media="(prefers-color-scheme: dark)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Stickly">
    <title>Stickly - Share Your Thoughts Anonymously</title>
    <link rel="stylesheet" href="style.css">
    <!-- Vercel Speed Insights - Configuration before the main script -->
    <script src="speed-insights.js"></script>
    <!-- Vercel Speed Insights - Main tracking script -->
    <script defer src="/_vercel/speed-insights/script.js"></script>
</head>
<body>
    <!-- Custom Cursor -->
    <div class="cursor-dot"></div>
    <div class="cursor-shadow"></div>
    
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand" onclick="showAdminLogin()" style="cursor: pointer;" title="Admin Access">
            <span class="logo">ðŸ’¬</span>
            <div>
                <h1>Stickly</h1>
                <p class="tagline">Your secrets are safe here</p>
            </div>
        </div>
        <div class="nav-links">
            <button class="nav-btn active" data-section="all" onclick="switchSection('all')">All</button>
            <button class="nav-btn" data-section="trending" onclick="switchSection('trending')">Trending</button>
            <button class="nav-btn" data-section="whistleblower" onclick="switchSection('whistleblower')">Whistleblower</button>
            <button class="nav-btn" data-section="controversy" onclick="switchSection('controversy')">Controversy</button>
            <button class="nav-btn" data-section="thoughts" onclick="switchSection('thoughts')">Thoughts</button>
            <button class="nav-btn" data-section="confessions" onclick="switchSection('confessions')">Confessions</button>
        </div>
        <div style="grid-area: actions; display: flex; gap: 0.75rem; align-items: center; justify-content: flex-end; flex-wrap: nowrap;">
            <div class="search-container" style="margin: 0;">
                <input type="text" id="searchInput" placeholder="ðŸ” Search messages..." oninput="filterMessages()">
            </div>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">
                <span id="darkModeIcon">ðŸŒ™</span>
            </button>
            <button class="profile-toggle" id="profileBtn" onclick="toggleProfileModal()" title="Profile Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="10" r="3"></circle><path d="M6.168 18.849A4 4 0 0 1 10 16h4a4 4 0 0 1 3.834 2.855"></path></svg>
            </button>
        </div>
    </nav>

    <!-- Floating Action Button -->
    <button class="fab" onclick="toggleModal()">
        <span class="fab-icon">+</span>
        <span class="fab-label">Post Message</span>
    </button>

    <!-- Post Message Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share a Message</h2>
                <button class="close-btn" onclick="toggleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="category-selector">
                    <label>Choose a category:</label>
                    <div class="category-buttons">
                        <button class="category-btn" data-category="whistleblower" onclick="selectCategory('whistleblower')">
                            <span class="emoji">ðŸ”“</span>
                            <span>Whistleblower</span>
                        </button>
                        <button class="category-btn" data-category="controversy" onclick="selectCategory('controversy')">
                            <span class="emoji">âš¡</span>
                            <span>Controversy</span>
                        </button>
                        <button class="category-btn active" data-category="thoughts" onclick="selectCategory('thoughts')">
                            <span class="emoji">ðŸ’­</span>
                            <span>Thoughts</span>
                        </button>
                        <button class="category-btn" data-category="confessions" onclick="selectCategory('confessions')">
                            <span class="emoji">ðŸ¤«</span>
                            <span>Confessions</span>
                        </button>
                        <button class="category-btn" data-category="others" onclick="selectCategory('others')">
                            <span class="emoji">ðŸ“Œ</span>
                            <span>Others</span>
                        </button>
                    </div>
                </div>
                
                <!-- Post as User Option -->
                <div class="post-as-user-section">
                    <label class="checkbox-container">
                        <input type="checkbox" id="postAsUser" onchange="toggleUserInfo()">
                        <span class="checkbox-label">Post with my profile</span>
                    </label>
                    <div id="userInfoDisplay" class="user-info-display" style="display: none;">
                        <div class="user-profile-editor">
                            <div class="user-avatar-selector" onclick="openEmojiPicker()">
                                <div class="user-avatar-large" id="postUserAvatar">ðŸ‘¤</div>
                                <div class="edit-avatar-hint">Click to change</div>
                            </div>
                            <div class="user-name-editor">
                                <input 
                                    type="text" 
                                    id="postUserNameInput" 
                                    class="username-input" 
                                    placeholder="Enter username"
                                    maxlength="20"
                                    oninput="updatePostUsername()"
                                />
                                <div class="username-hint">Max 20 characters</div>
                            </div>
                        </div>
                        <button class="save-profile-btn" onclick="savePostProfile()">
                            ðŸ’¾ Save to Profile
                        </button>
                    </div>
                </div>
                
                <!-- Emoji Picker Modal -->
                <div id="emojiPickerModal" class="emoji-picker-modal" style="display: none;">
                    <div class="emoji-picker-content">
                        <div class="emoji-picker-header">
                            <h3>Choose Avatar</h3>
                            <button class="emoji-close-btn" onclick="closeEmojiPicker()">Ã—</button>
                        </div>
                        <div class="emoji-grid" id="emojiGrid"></div>
                    </div>
                </div>
                
                <textarea 
                    id="messageInput" 
                    placeholder="What's on your mind?"
                    maxlength="500"
                ></textarea>
                <div class="image-upload-section">
                    <label for="imageUpload" class="image-upload-label">
                        <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                        </svg>
                        <span class="upload-text">Attach Image or GIF</span>
                    </label>
                    <input 
                        type="file" 
                        id="imageUpload" 
                        accept="image/jpeg,image/jpg,image/gif,image/png"
                        style="display: none;"
                    />
                    <div style="text-align: center; margin: 0.5rem 0; color: var(--subtle-text-color); font-size: 0.9rem;">or</div>
                    <input 
                        type="text" 
                        id="imageUrl" 
                        placeholder="Paste image/GIF URL"
                        class="admin-input"
                        style="margin-bottom: 0.5rem;"
                    />
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                <div class="form-footer">
                    <span class="char-count">0/500</span>
                    <button class="post-btn" id="postBtn" onclick="postMessage()">Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="adminModalTitle">Admin Login</h2>
                <button class="close-btn" onclick="toggleAdminModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="adminLoginForm">
                    <input 
                        type="text" 
                        id="adminUsername" 
                        placeholder="Username"
                        class="admin-input"
                    />
                    <input 
                        type="password" 
                        id="adminPassword" 
                        placeholder="Password"
                        class="admin-input"
                    />
                    <button class="post-btn" onclick="adminLogin()" style="width: 100%; margin-top: 1rem;">Login</button>
                </div>
                <div id="adminPanel" style="display: none;">
                    <p style="text-align: center; color: var(--text-color); margin-bottom: 1rem;">âœ… Logged in as Admin</p>
                    <button class="post-btn" onclick="adminLogout()" style="width: 100%; background: #ff4444;">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ðŸ‘¤ Profile Settings</h2>
                <button class="close-btn" onclick="toggleProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.75rem; color: var(--text-color); font-weight: 600; font-size: 1rem;">Username</label>
                    <div style="position: relative;">
                        <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--accent-color); font-weight: 700; font-size: 1.1rem; z-index: 1;">@</span>
                        <input type="text" id="usernameInput" class="admin-input" placeholder="username" maxlength="20" value="" style="padding-left: 2.5rem;">
                    </div>
                    <small style="display: block; margin-top: 0.5rem; color: var(--subtle-text-color); font-size: 0.85rem;">âœ¨ Max 20 characters â€¢ No spaces allowed</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.75rem; color: var(--text-color); font-weight: 600; font-size: 1rem;">Choose Your Avatar</label>
                    <div id="avatarGrid" class="avatar-grid">
                        <!-- Avatars will be generated here -->
                    </div>
                    <button class="secondary-btn" onclick="regenerateAvatars()" style="width: 100%; margin-top: 1rem;">
                        ðŸŽ² Shuffle Avatars
                    </button>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(0,113,227,0.08), rgba(10,132,255,0.08)); border-radius: 12px; border: 2px solid rgba(0,113,227,0.2); box-shadow: 0 4px 12px rgba(0,113,227,0.1);">
                    <p style="margin: 0 0 0.75rem 0; color: var(--text-color); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7;">Preview</p>
                    <div id="profilePreview" style="display: flex; align-items: center; gap: 0.75rem;">
                        <span class="message-avatar">ðŸ‘¤</span>
                        <span style="font-weight: 700; font-size: 1.05rem; color: var(--text-color); display: flex; align-items: center;"><span style="color: var(--accent-color); margin-right: 2px;">@</span>Anonymous</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.75rem;">
                    <button class="post-btn" onclick="saveUserProfile()" style="flex: 1;">ðŸ’¾ Save Profile</button>
                    <button class="cancel-btn" onclick="toggleProfileModal()" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="main-container">
        <div class="section-header">
            <h2 id="sectionTitle">All Messages</h2>
            <p id="sectionSubtitle">Anonymous messages from around the world</p>
        </div>
        <div id="messagesList"></div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Report Message</h2>
                <button class="close-btn" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-color);">Why are you reporting this message?</p>
                <select id="reportReason" class="admin-input" style="margin-bottom: 1rem;">
                    <option value="">Select a reason...</option>
                    <option value="spam">Spam</option>
                    <option value="harassment">Harassment or bullying</option>
                    <option value="hate">Hate speech</option>
                    <option value="violence">Violence or threats</option>
                    <option value="inappropriate">Inappropriate content</option>
                    <option value="other">Other</option>
                </select>
                <button class="post-btn" onclick="submitReport()" style="width: 100%;">Submit Report</button>
                <button class="cancel-btn" onclick="closeReportModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="" alt="Full size image">
    </div>

    <!-- Footer -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Footer -->
    <footer class="footer">
        <p>Made by GigaNigga Atharv & Ankit</p>
    </footer>

    <script>
        let currentSection = 'all';
        let selectedCategory = 'thoughts';
        let adminSessionId = localStorage.getItem('adminSessionId') || null;

        // Admin functions
        function toggleAdminModal() {
            const modal = document.getElementById('adminModal');
            modal.classList.toggle('show');
            checkAdminStatus();
        }

        async function checkAdminStatus() {
            const adminBtn = document.getElementById('adminBtn');
            const loginForm = document.getElementById('adminLoginForm');
            const adminPanel = document.getElementById('adminPanel');
            
            if (!adminSessionId) {
                adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
                loginForm.style.display = 'block';
                adminPanel.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/admin/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });
                const data = await response.json();
                
                if (data.isAdmin) {
                    adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>';
                    adminBtn.style.background = 'linear-gradient(135deg, #0071e3, #0077ed)';
                    adminBtn.style.color = 'white';
                    loginForm.style.display = 'none';
                    adminPanel.style.display = 'block';
                } else {
                    adminSessionId = null;
                    localStorage.removeItem('adminSessionId');
                    adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
                    adminBtn.style.background = '';
                    adminBtn.style.color = '';
                    loginForm.style.display = 'block';
                    adminPanel.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    adminSessionId = data.sessionId;
                    localStorage.setItem('adminSessionId', adminSessionId);
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminPassword').value = '';
                    toggleAdminModal();
                    checkAdminStatus();
                    loadMessages();
                } else {
                    alert('Invalid credentials');
                }
            } catch (error) {
                console.error('Error logging in:', error);
                alert('Error logging in');
            }
        }

        async function adminLogout() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });
                
                adminSessionId = null;
                localStorage.removeItem('adminSessionId');
                toggleAdminModal();
                checkAdminStatus();
                loadMessages();
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Profile functions
        const AVATAR_EMOJIS = ['ðŸ˜€', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ˜º', 'ðŸ¶', 'ðŸ¦Š', 'ðŸ¼', 'ðŸ¦', 'ðŸ¸', 'ðŸ¦„', 'ðŸŒŸ', 'âš¡', 'ðŸ”¥', 'ðŸ’Ž', 'ðŸŽ¨', 'ðŸŽ­', 'ðŸŽª', 'ðŸŽ¯', 'ðŸŽ²', 'ðŸŽ¸', 'ðŸš€', 'ðŸŒˆ', 'ðŸŒ¸', 'ðŸ•', 'ðŸ”', 'ðŸ©', 'ðŸŽ‚', 'â˜•', 'ðŸŒ', 'ðŸ†'];

        function getUserProfile() {
            const username = sessionStorage.getItem('userUsername') || 'Anonymous';
            const avatar = sessionStorage.getItem('userAvatar') || 'ðŸ‘¤';
            return { username, avatar };
        }

        function showAdminLogin() {
            toggleAdminModal();
        }

        function toggleProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.toggle('show');
            
            if (modal.classList.contains('show')) {
                const profile = getUserProfile();
                document.getElementById('usernameInput').value = profile.username === 'Anonymous' ? '' : profile.username;
                generateAvatars(profile.avatar);
                updateProfilePreview();
            }
        }

        function generateAvatars(selectedAvatar = null) {
            const avatarGrid = document.getElementById('avatarGrid');
            const shuffled = [...AVATAR_EMOJIS].sort(() => Math.random() - 0.5);
            const avatars = shuffled.slice(0, 12);
            
            // If there's a selected avatar, make sure it's in the grid
            if (selectedAvatar && !avatars.includes(selectedAvatar)) {
                avatars[0] = selectedAvatar;
            }
            
            avatarGrid.innerHTML = avatars.map(emoji => `
                <div class="avatar-option ${emoji === selectedAvatar ? 'selected' : ''}" 
                     data-avatar="${emoji}" 
                     onclick="selectAvatar('${emoji}')">
                    ${emoji}
                </div>
            `).join('');
        }

        function regenerateAvatars() {
            const profile = getUserProfile();
            generateAvatars(profile.avatar);
        }

        function selectAvatar(emoji) {
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            updateProfilePreview();
        }

        function updateProfilePreview() {
            let username = document.getElementById('usernameInput').value.trim().replace(/\s+/g, '') || 'Anonymous';
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const avatar = selectedAvatar ? selectedAvatar.dataset.avatar : 'ðŸ‘¤';
            
            document.getElementById('profilePreview').innerHTML = `
                <span class="message-avatar">${avatar}</span>
                <span style="font-weight: 700; font-size: 1.05rem; color: var(--text-color); display: flex; align-items: center;"><span style="color: var(--accent-color); margin-right: 2px;">@</span>${username}</span>
            `;
        }

        function saveUserProfile() {
            let username = document.getElementById('usernameInput').value.trim().replace(/\s+/g, '') || 'Anonymous';
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const avatar = selectedAvatar ? selectedAvatar.dataset.avatar : 'ðŸ‘¤';
            
            // Remove any @ symbols user might have typed
            username = username.replace(/@/g, '');
            
            sessionStorage.setItem('userUsername', username);
            sessionStorage.setItem('userAvatar', avatar);
            
            // Show success animation
            const modal = document.getElementById('profileModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.animation = 'pulse 0.3s ease';
            
            setTimeout(() => {
                toggleProfileModal();
                modalContent.style.animation = '';
            }, 300);
        }

        // Update username input live preview
        document.addEventListener('DOMContentLoaded', () => {
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.addEventListener('input', (e) => {
                    // Remove spaces and @ symbols as user types
                    e.target.value = e.target.value.replace(/[\s@]/g, '');
                    updateProfilePreview();
                });
            }
        });

        // Image upload preview
        function initImageUpload() {
            const imageUpload = document.getElementById('imageUpload');
            const imageUrl = document.getElementById('imageUrl');
            const imagePreview = document.getElementById('imagePreview');

            const normalizeImageUrl = (value) => {
                const raw = (value || '').trim();
                if (!raw) return '';
                if (/^(https?:\/\/|data:image\/)/i.test(raw)) return raw;
                return `https://${raw}`;
            };
            
            if (!imageUpload) return;
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('Image selected:', file.name, file.type);
                    imageUrl.value = ''; // Clear URL input
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.innerHTML = `
                            <div class="preview-container">
                                <img src="${e.target.result}" alt="Preview" />
                                <button class="remove-image" onclick="removeImage()">Ã—</button>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle URL input
            if (imageUrl) {
                imageUrl.addEventListener('input', (e) => {
                    const url = normalizeImageUrl(e.target.value);
                    if (url) {
                        imageUpload.value = ''; // Clear file upload
                        const looksLikeImage = /^data:image\//i.test(url) || /\.(gif|png|jpe?g|webp|avif|bmp|svg)(\?.*)?(#.*)?$/i.test(url);
                        imagePreview.innerHTML = '';

                        const previewContainer = document.createElement('div');
                        previewContainer.className = 'preview-container';

                        const previewImage = document.createElement('img');
                        previewImage.alt = 'Preview';
                        previewImage.src = url;

                        const removeButton = document.createElement('button');
                        removeButton.className = 'remove-image';
                        removeButton.type = 'button';
                        removeButton.textContent = 'Ã—';
                        removeButton.addEventListener('click', removeImage);

                        previewImage.onerror = () => {
                            previewContainer.innerHTML = '';
                            const warning = document.createElement('p');
                            warning.style.color = 'var(--subtle-text-color)';
                            warning.style.textAlign = 'center';
                            warning.textContent = 'Could not preview this link. If it is a direct image/GIF URL, it can still be posted.';
                            previewContainer.appendChild(warning);
                            previewContainer.appendChild(removeButton);
                        };

                        previewContainer.appendChild(previewImage);
                        previewContainer.appendChild(removeButton);
                        imagePreview.appendChild(previewContainer);

                        if (!looksLikeImage) {
                            const tip = document.createElement('p');
                            tip.style.marginTop = '0.4rem';
                            tip.style.color = 'var(--subtle-text-color)';
                            tip.style.fontSize = '0.8rem';
                            tip.style.textAlign = 'center';
                            tip.textContent = 'Tip: use a direct image URL ending in .gif, .png, .jpg, etc.';
                            imagePreview.appendChild(tip);
                        }
                    } else {
                        imagePreview.innerHTML = '';
                    }
                });
            }
        }

        function removeImage() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('imageUrl').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }

        // Load messages when page loads
        window.onload = () => {
            switchSection('all');
            updateCharCount();
            initDarkMode();
            initFAB();
            initImageUpload();
            checkAdminStatus();
        };

        // FAB collapse functionality
        function initFAB() {
            const fab = document.querySelector('.fab');
            let timeout;

            // Auto-collapse after 3 seconds
            timeout = setTimeout(() => {
                fab.classList.add('collapsed');
            }, 3000);

            // Expand on hover
            fab.addEventListener('mouseenter', () => {
                clearTimeout(timeout);
                fab.classList.remove('collapsed');
            });

            // Collapse after leaving
            fab.addEventListener('mouseleave', () => {
                timeout = setTimeout(() => {
                    fab.classList.add('collapsed');
                }, 1000);
            });
        }

        // Dark mode functionality
        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            }
            updateLikeIconsForCurrentTheme();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeIcon').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            updateLikeIconsForCurrentTheme();
        }

        function getLikeHeartIcon(isLiked) {
            if (!isLiked) return 'ðŸ¤';
            return document.body.classList.contains('dark-mode') ? 'ðŸ¤' : 'â¤ï¸';
        }

        function updateLikeIconsForCurrentTheme() {
            document.querySelectorAll('.like-btn').forEach(btn => {
                const heart = btn.querySelector('.heart-icon');
                if (!heart) return;
                const isLiked = btn.classList.contains('liked');
                heart.textContent = getLikeHeartIcon(isLiked);
            });
        }

        // Update character count
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', updateCharCount);

        function updateCharCount() {
            const count = messageInput.value.length;
            document.querySelector('.char-count').textContent = `${count}/500`;
        }

        // Switch section
        function switchSection(section) {
            currentSection = section;
            searchQuery = ''; // Reset search when switching sections
            document.getElementById('searchInput').value = '';
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === section);
            });

            const titles = {
                'all': { icon: 'ðŸ’¬', title: 'All Messages', subtitle: 'Anonymous messages from around the world' },
                'trending': { icon: 'ðŸ”¥', title: 'Trending', subtitle: 'Most liked messages right now' },
                'whistleblower': { icon: 'ðŸ”“', title: 'Whistleblower', subtitle: 'Reveal the truth - Expose scams, corruption, and company secrets' },
                'controversy': { icon: 'âš¡', title: 'Controversy', subtitle: 'Hot takes and heated debates' },
                'thoughts': { icon: 'ðŸ’­', title: 'Thoughts', subtitle: 'Random thoughts and musings' },
                'confessions': { icon: 'ðŸ¤«', title: 'Confessions', subtitle: 'Anonymous secrets and stories' }
            };

            const sectionMeta = titles[section] || titles['all'];
            document.getElementById('sectionTitle').innerHTML = `<span class="section-icon">${sectionMeta.icon}</span> ${sectionMeta.title}`;
            document.getElementById('sectionSubtitle').textContent = sectionMeta.subtitle;

            // Trigger section-specific effects
            if (section === 'whistleblower') {
                createMatrixRain();
            } else if (section === 'controversy') {
                createLightningBolts();
            } else if (section === 'thoughts') {
                createThoughtBubbles();
            } else if (section === 'confessions') {
                createWhisperBubbles();
            }

            loadMessages();
        }

        function showLoadingSkeletons() {
            const messagesList = document.getElementById('messagesList');
            const skeletonCount = 6;
            const skeletons = Array.from({ length: skeletonCount }).map(() => `
                <div class="skeleton-card">
                    <div class="skeleton-header">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-lines">
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line medium"></div>
                        </div>
                    </div>
                    <div class="skeleton-line full"></div>
                    <div class="skeleton-line full"></div>
                    <div class="skeleton-line medium"></div>
                    <div class="skeleton-actions">
                        <div class="skeleton-pill"></div>
                        <div class="skeleton-pill"></div>
                        <div class="skeleton-pill"></div>
                        <div class="skeleton-pill"></div>
                    </div>
                </div>
            `).join('');

            messagesList.innerHTML = `<div class="skeleton-grid">${skeletons}</div>`;
            messagesList.style.minHeight = 'auto';
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 220);
            }, 2200);
        }

        // Common emoji list for avatars
        const avatarEmojis = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ¤£','ðŸ˜‚','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜Š','ï¿½ï¿½ï¿½','ðŸ¥°','ðŸ˜','ðŸ¤©','ðŸ˜˜','ðŸ˜—','â˜ºï¸','ðŸ˜š','ðŸ˜™','ðŸ¥²','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ˜','ðŸ¤‘','ðŸ¤—','ðŸ¤­','ðŸ¤«','ðŸ¤”','ðŸ¤','ðŸ¤¨','ðŸ˜','ðŸ˜‘','ðŸ˜¶','ðŸ˜','ðŸ˜’','ðŸ™„','ðŸ˜¬','ðŸ¤¥','ðŸ˜Œ','ðŸ˜”','ðŸ˜ª','ðŸ¤¤','ðŸ˜´','ðŸ˜·','ðŸ¤’','ðŸ¤•','ðŸ¤¢','ðŸ¤®','ðŸ¤§','ðŸ¥µ','ðŸ¥¶','ðŸ¥´','ðŸ˜µ','ðŸ¤¯','ðŸ¤ ','ðŸ¥³','ðŸ¥¸','ðŸ˜Ž','ðŸ¤“','ðŸ§','ðŸ˜•','ðŸ˜Ÿ','ðŸ™','â˜¹ï¸','ðŸ˜®','ðŸ˜¯','ðŸ˜²','ðŸ˜³','ðŸ¥º','ðŸ˜¦','ðŸ˜§','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜¢','ðŸ˜­','ðŸ˜±','ðŸ˜–','ðŸ˜£','ðŸ˜ž','ðŸ˜“','ðŸ˜©','ðŸ˜«','ðŸ¥±','ðŸ˜¤','ðŸ˜¡','ðŸ˜ ','ðŸ¤¬','ðŸ˜ˆ','ðŸ‘¿','ðŸ’€','â˜ ï¸','ðŸ’©','ðŸ¤¡','ðŸ‘¹','ðŸ‘º','ðŸ‘»','ðŸ‘½','ðŸ‘¾','ðŸ¤–','ðŸ˜º','ðŸ˜¸','ðŸ˜¹','ðŸ˜»','ðŸ˜¼','ðŸ˜½','ðŸ™€','ðŸ˜¿','ðŸ˜¾','ðŸ™ˆ','ðŸ™‰','ðŸ™Š','ðŸ’‹','ðŸ’Œ','ðŸ’˜','ðŸ’','ðŸ’–','ðŸ’—','ðŸ’“','ðŸ’ž','ðŸ’•','ðŸ’Ÿ','â£ï¸','ðŸ’”','â¤ï¸','ðŸ§¡','ðŸ’›','ðŸ’š','ðŸ’™','ðŸ’œ','ðŸ¤Ž','ðŸ–¤','ðŸ¤','ðŸ’¯','ðŸ’¢','ðŸ’¥','ðŸ’«','ðŸ’¦','ðŸ’¨','ðŸ•³ï¸','ðŸ’£','ðŸ’¬','ðŸ‘ï¸','ðŸ—¨ï¸','ðŸ—¯ï¸','ðŸ’­','ðŸ’¤','ðŸ‘‹','ðŸ¤š','ðŸ–ï¸','âœ‹','ðŸ––','ðŸ‘Œ','ðŸ¤Œ','ðŸ¤','âœŒï¸','ðŸ¤ž','ðŸ¤Ÿ','ðŸ¤˜','ðŸ¤™','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ–•','ðŸ‘‡','â˜ï¸','ðŸ‘','ðŸ‘Ž','âœŠ','ðŸ‘Š','ðŸ¤›','ðŸ¤œ','ðŸ‘','ðŸ™Œ','ðŸ‘','ðŸ¤²','ðŸ¤','ðŸ™','âœï¸','ðŸ’…','ðŸ¤³','ðŸ’ª','ðŸ¦¾','ðŸ¦¿','ðŸ¦µ','ðŸ¦¶','ðŸ‘‚','ðŸ¦»','ðŸ‘ƒ','ðŸ§ ','ðŸ«€','ðŸ«','ðŸ¦·','ðŸ¦´','ðŸ‘€','ðŸ‘ï¸','ðŸ‘…','ðŸ‘„','ðŸ¶','ðŸ±','ðŸ­','ðŸ¹','ðŸ°','ðŸ¦Š','ðŸ»','ðŸ¼','ðŸ¨','ðŸ¯','ðŸ¦','ðŸ®','ðŸ·','ðŸ¸','ðŸµ','ðŸ”','ðŸ§','ðŸ¦','ðŸ¤','ðŸ¦†','ðŸ¦…','ðŸ¦‰','ðŸ¦‡','ðŸº','ðŸ—','ðŸ´','ðŸ¦„','ðŸ','ðŸª±','ðŸ›','ðŸ¦‹','ðŸŒ','ðŸž','ðŸœ','ðŸª°','ðŸª²','ðŸª³','ðŸ¦Ÿ','ðŸ¦—','ðŸ•·ï¸','ðŸ•¸ï¸','ðŸ¦‚','ðŸ¢','ðŸ','ðŸ¦Ž','ðŸ¦–','ðŸ¦•','ðŸ™','ðŸ¦‘','ðŸ¦','ðŸ¦ž','ðŸ¦€','ðŸ¡','ðŸ ','ðŸŸ','ðŸ¬','ðŸ³','ðŸ‹','ðŸ¦ˆ','ðŸŠ','ðŸ…','ðŸ†','ðŸ¦“','ðŸ¦','ðŸ¦§','ðŸ¦£','ðŸ˜','ðŸ¦›','ðŸ¦','ðŸª','ðŸ«','ðŸ¦’','ðŸ¦˜','ðŸ¦¬','ðŸƒ','ðŸ‚','ðŸ„','ðŸŽ','ðŸ–','ðŸ','ðŸ‘','ðŸ¦™','ðŸ','ðŸ¦Œ','ðŸ•','ðŸ©','ðŸ¦®','ðŸ•â€ðŸ¦º','ðŸˆ','ðŸˆâ€â¬›','ðŸª¶','ðŸ“','ðŸ¦ƒ','ðŸ¦¤','ðŸ¦š','ðŸ¦œ','ðŸ¦¢','ðŸ¦©','ðŸ•Šï¸','ðŸ‡','ðŸ¦','ðŸ¦¨','ðŸ¦¡','ðŸ¦«','ðŸ¦¦','ðŸ¦¥','ðŸ','ðŸ€','ðŸ¿ï¸','ðŸ¦”','ðŸŒµ','ðŸŽ„','ðŸŒ²','ðŸŒ³','ðŸŒ´','ðŸŒ±','ðŸŒ¿','â˜˜ï¸','ðŸ€','ðŸŽ','ðŸŽ‹','ðŸƒ','ðŸ‚','ðŸ','ðŸ„','ðŸš','ðŸŒ¾','ðŸ’','ðŸŒ·','ðŸŒ¹','ðŸ¥€','ðŸŒº','ðŸŒ¸','ðŸŒ¼','ðŸŒ»','ðŸŒž','ðŸŒ','ðŸŒ›','ðŸŒœ','ðŸŒš','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜','ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ™','ðŸŒŽ','ðŸŒ','ðŸŒ','ðŸª','ðŸ’«','â­','ðŸŒŸ','âœ¨','âš¡','â˜„ï¸','ðŸ’¥','ðŸ”¥','ðŸŒªï¸','ðŸŒˆ','â˜€ï¸','ðŸŒ¤ï¸','â›…','ðŸŒ¥ï¸','â˜ï¸','ðŸŒ¦ï¸','ðŸŒ§ï¸','â›ˆï¸','ðŸŒ©ï¸','ðŸŒ¨ï¸','â„ï¸','â˜ƒï¸','â›„','ðŸŒ¬ï¸','ðŸ’¨','ðŸ’§','ðŸ’¦','â˜”','â˜‚ï¸','ðŸŒŠ','ðŸŒ«ï¸'];

        // Toggle user info display
        function toggleUserInfo() {
            const postAsUser = document.getElementById('postAsUser').checked;
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            
            if (postAsUser) {
                const profile = getUserProfile();
                document.getElementById('postUserAvatar').textContent = profile.avatar;
                document.getElementById('postUserNameInput').value = profile.username;
                userInfoDisplay.style.display = 'block';
            } else {
                userInfoDisplay.style.display = 'none';
            }
        }

        // Open emoji picker
        function openEmojiPicker() {
            const modal = document.getElementById('emojiPickerModal');
            const grid = document.getElementById('emojiGrid');
            
            // Populate emoji grid
            grid.innerHTML = avatarEmojis.map(emoji => 
                `<div class="emoji-option" onclick="selectPostAvatar('${emoji}')">${emoji}</div>`
            ).join('');
            
            modal.style.display = 'flex';
        }

        // Close emoji picker
        function closeEmojiPicker() {
            document.getElementById('emojiPickerModal').style.display = 'none';
        }

        // Select avatar for post
        function selectPostAvatar(emoji) {
            document.getElementById('postUserAvatar').textContent = emoji;
            closeEmojiPicker();
        }

        // Update username preview
        function updatePostUsername() {
            const input = document.getElementById('postUserNameInput');
            const username = input.value.trim() || 'Anonymous';
            // Remove special characters and limit length
            input.value = input.value.replace(/[^a-zA-Z0-9_\s]/g, '').substring(0, 20);
        }

        // Save profile changes
        function savePostProfile() {
            const username = document.getElementById('postUserNameInput').value.trim() || 'Anonymous';
            const avatar = document.getElementById('postUserAvatar').textContent;
            
            const profile = {
                username: username,
                avatar: avatar
            };
            
            sessionStorage.setItem('userProfile', JSON.stringify(profile));
            
            // Update main profile display if it exists
            const profileAvatar = document.getElementById('profileAvatar');
            const profileUsername = document.getElementById('profileUsername');
            if (profileAvatar) profileAvatar.textContent = avatar;
            if (profileUsername) profileUsername.textContent = username;
            
            // Show success feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Saved!';
            btn.style.background = 'linear-gradient(135deg, #52c234, #61e049)';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        }

        // Toggle modal
        function toggleModal() {
            const modal = document.getElementById('postModal');
            const isClosing = modal.classList.contains('show');
            
            if (isClosing) {
                // Clear inputs when closing modal
                messageInput.value = '';
                const imageUpload = document.getElementById('imageUpload');
                const imageUrl = document.getElementById('imageUrl');
                if (imageUpload) {
                    imageUpload.value = '';
                    imageUrl.value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                }
                // Reset post as user checkbox
                document.getElementById('postAsUser').checked = false;
                document.getElementById('userInfoDisplay').style.display = 'none';
                updateCharCount();
            }
            
            modal.classList.toggle('show');
        }

        // Select category
        function selectCategory(category) {
            selectedCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
        }

        // Load messages
        async function loadMessages() {
            try {
                showLoadingSkeletons();

                const url = (currentSection === 'all' || currentSection === 'trending')
                    ? '/api/messages'
                    : `/api/messages?category=${currentSection}`;
                
                const response = await fetch(url);
                let messages = await response.json();

                if (currentSection === 'trending') {
                    messages = messages
                        .slice()
                        .sort((a, b) => (b.likes || 0) - (a.likes || 0));
                }

                allMessages = messages; // Store for filtering
                displayMessages(messages);
                updateMessageCounts();
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Post a new message
        async function postMessage() {
            const messageText = messageInput.value.trim();
            const imageUpload = document.getElementById('imageUpload');
            const imageUrl = document.getElementById('imageUrl');
            const modalContent = document.querySelector('.modal-content');
            const postBtn = document.getElementById('postBtn');
            
            // Allow posting if either message, file, or URL is present
            if (!messageText && (!imageUpload || !imageUpload.files[0]) && (!imageUrl || !imageUrl.value.trim())) {
                modalContent.classList.add('shake');
                setTimeout(() => modalContent.classList.remove('shake'), 400);
                return;
            }

            // Prevent multiple clicks
            if (postBtn.disabled) return;
            
            // Disable button and show loading state
            postBtn.disabled = true;
            const originalText = postBtn.textContent;
            postBtn.textContent = 'Posting...';
            postBtn.style.opacity = '0.6';
            postBtn.style.cursor = 'not-allowed';

            try {
                const formData = new FormData();
                formData.append('message', messageText || '');
                formData.append('category', selectedCategory);
                
                // Check if user wants to post with profile
                const postAsUser = document.getElementById('postAsUser').checked;
                if (postAsUser) {
                    // Use values from the editor
                    const username = document.getElementById('postUserNameInput').value.trim() || 'Anonymous';
                    const avatar = document.getElementById('postUserAvatar').textContent;
                    formData.append('username', username);
                    formData.append('avatar', avatar);
                } else {
                    // Post as anonymous
                    formData.append('username', 'Anonymous');
                    formData.append('avatar', 'ðŸ•µï¸');
                }
                
                if (imageUpload && imageUpload.files[0]) {
                    console.log('Uploading image:', imageUpload.files[0].name);
                    formData.append('image', imageUpload.files[0]);
                } else if (imageUrl && imageUrl.value.trim()) {
                    const normalizedImageUrl = imageUrl.value.trim().match(/^(https?:\/\/|data:image\/)/i)
                        ? imageUrl.value.trim()
                        : `https://${imageUrl.value.trim()}`;
                    console.log('Using image URL:', normalizedImageUrl);
                    formData.append('imageUrl', normalizedImageUrl);
                }

                const response = await fetch('/api/messages', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Message posted successfully:', result);
                    
                    // Show success feedback
                    postBtn.textContent = 'âœ” Posted!';
                    postBtn.style.background = 'linear-gradient(135deg, #52c234, #61e049)';
                    
                    // Wait a moment to show success state
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    messageInput.value = '';
                    if (imageUpload) {
                        imageUpload.value = '';
                        imageUrl.value = '';
                        document.getElementById('imagePreview').innerHTML = '';
                    }
                    updateCharCount();
                    toggleModal();
                    createConfetti();
                    
                    // Auto jump to "All" section to see the new post
                    switchSection('all');
                } else {
                    const error = await response.json();
                    console.error('Error response:', error);
                    postBtn.textContent = 'âœ— Failed';
                    postBtn.style.background = 'linear-gradient(135deg, #ff4444, #cc0000)';
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    if (error.error) {
                        alert(error.error);
                    } else {
                        alert('Error posting message. Please try again.');
                    }
                }
            } catch (error) {
                console.error('Error posting message:', error);
                postBtn.textContent = 'âœ— Error';
                postBtn.style.background = 'linear-gradient(135deg, #ff4444, #cc0000)';
                await new Promise(resolve => setTimeout(resolve, 1500));
                alert('Error posting message. Please try again.');
            } finally {
                // Reset button state
                postBtn.disabled = false;
                postBtn.textContent = originalText;
                postBtn.style.opacity = '1';
                postBtn.style.cursor = 'pointer';
                postBtn.style.background = '';
            }
        }

        // Display messages as cards
        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            
            // Filter by search query if present
            let filteredMessages = messages;
            if (searchQuery) {
                filteredMessages = messages.filter(msg => 
                    msg.text.toLowerCase().includes(searchQuery) ||
                    msg.category.toLowerCase().includes(searchQuery)
                );
            }
            
            if (filteredMessages.length === 0) {
                const noMsgText = searchQuery 
                    ? `No messages found matching "${searchQuery}"`
                    : (currentSection === 'trending'
                        ? 'No trending messages yet. Get likes to trend!'
                        : 'No messages in this category yet. Be the first to share!');
                messagesList.innerHTML = `<div class="no-messages">${noMsgText}</div>`;
                return;
            }

            const containerWidth = messagesList.offsetWidth || 1200;
            const cardWidth = 300;
            const gap = 40;
            const cardsPerRow = Math.floor(containerWidth / (cardWidth + gap));

            const categoryEmojis = {
                'whistleblower': 'ðŸ”“',
                'controversy': 'âš¡',
                'thoughts': 'ðŸ’­',
                'confessions': 'ðŸ¤«',
                'others': 'ðŸ“Œ'
            };

            const fragment = document.createDocumentFragment();
            const totalRows = Math.ceil(filteredMessages.length / cardsPerRow);

            filteredMessages.forEach((msg, index) => {
                const timeAgo = getTimeAgo(new Date(msg.timestamp));
                const row = Math.floor(index / cardsPerRow);
                const col = index % cardsPerRow;
                const left = col * (cardWidth + gap);
                const top = row * (cardWidth + gap);

                const card = document.createElement('div');
                card.className = 'message-card';
                card.setAttribute('data-category', msg.category);
                card.style.cssText = `left: ${left}px; top: ${top}px; animation-delay: ${index * 0.05}s; width: ${cardWidth}px;`;
                
                const isLiked = likedMessages.includes(msg.id);
                const likesCount = msg.likes || 0;
                const repliesCount = msg.replies ? msg.replies.length : 0;
                
                const username = msg.username || 'Anonymous';
                const avatar = msg.avatar || 'ðŸ‘¤';

                const repliesList = (msg.replies || []).map(r => `
                    <div class="reply-item">
                        <div class="reply-header">
                            <span class="reply-avatar">${r.avatar || 'ðŸ‘¤'}</span>
                            <span class="reply-author">${escapeHtml(r.username || 'Anonymous')}</span>
                            <span class="reply-time">â€¢ ${getTimeAgo(new Date(r.timestamp))}</span>
                        </div>
                        <div class="reply-content">${escapeHtml(r.text)}</div>
                    </div>
                `).join('');

                const inlineRepliesHtml = `
                    <div id="replies-${msg.id}" class="replies-wrapper">
                        <div class="replies-list">${repliesList}</div>
                        <div class="reply-input-container">
                            <input type="text" id="reply-input-${msg.id}" class="reply-input" placeholder="Write a reply..." autocomplete="off" onkeypress="if(event.key === 'Enter') submitReply(${msg.id})">
                            <button class="reply-send-btn" onclick="submitReply(${msg.id})" title="Send reply">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            </button>
                        </div>
                    </div>
                `;
                
                card.innerHTML = `
                    <div class="message-header">
                        <div class="message-user-block">
                            <span class="message-avatar">${avatar}</span>
                            <div class="message-user-meta">
                                <span class="message-username">${escapeHtml(username)}</span>
                                <span class="category-badge"><span class="badge-emoji">${categoryEmojis[msg.category]}</span><span class="badge-text">${msg.category}</span></span>
                            </div>
                        </div>
                        <div class="message-actions">
                            <span class="message-time">${timeAgo}</span>
                            <button class="delete-btn" onclick="deleteMessage(${msg.id})" title="Delete message" aria-label="Delete message">Ã—</button>
                        </div>
                    </div>
                    <p class="message-text">${escapeHtml(msg.text)}</p>
                    ${msg.image ? `<img src="${msg.image}" alt="Attached image" class="message-image" onclick="openImageModal('${msg.image}')" />` : ''}
                    <div class="message-footer">
                        <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(${msg.id}, event)" title="Like this message" aria-label="Like message">
                            <span class="heart-icon">${getLikeHeartIcon(isLiked)}</span>
                            <span class="like-count">${likesCount}</span>
                        </button>
                        <button class="reply-btn" onclick="toggleReplies(${msg.id}, event)" title="Reply to this message" aria-label="Reply to message">
                            <span>ðŸ’¬</span>
                            <span>${repliesCount}</span>
                        </button>
                        <button class="share-btn" onclick="shareMessage(${msg.id}, event)" title="Share this message" aria-label="Share message">ðŸ”—</button>
                        <button class="report-btn" onclick="openReportModal(${msg.id}, event)" title="Report this message" aria-label="Report message">ðŸš©</button>
                    </div>
                    ${inlineRepliesHtml}
                `;
                
                fragment.appendChild(card);
            });

            messagesList.innerHTML = '';
            messagesList.appendChild(fragment);
            messagesList.style.minHeight = (totalRows * (cardWidth + gap)) + 'px';

            // Add effects
            document.querySelectorAll('.message-card').forEach(makeDraggable);
        }

        // Confetti animation
        function createConfetti() {
            const colors = ['#FF6B6B', '#FF9F43', '#95E1D3', '#F38181', '#A29BFE', '#6BCF7F'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = (Math.random() * 10 + 5) + 'px';
                    confetti.style.opacity = '1';
                    confetti.style.animation = `confetti-fall ${Math.random() * 2 + 2}s linear forwards`;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        // Matrix Rain Effect for Whistleblower section
        function createMatrixRain() {
            const chars = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒŽãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒžãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³';
            const drops = 30;
            
            for (let i = 0; i < drops; i++) {
                setTimeout(() => {
                    const matrixChar = document.createElement('div');
                    matrixChar.className = 'matrix-char';
                    matrixChar.textContent = chars[Math.floor(Math.random() * chars.length)];
                    matrixChar.style.left = Math.random() * 100 + '%';
                    matrixChar.style.top = '-20px';
                    
                    const duration = Math.random() * 1 + 1.5; // 1.5-2.5 seconds
                    matrixChar.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(matrixChar);
                    
                    // Remove after animation
                    setTimeout(() => matrixChar.remove(), duration * 1000);
                }, i * 50);
            }
        }

        // Floating Books Effect for Knowledge section
        function createFloatingBooks() {
            const bookEmojis = ['ðŸ“•', 'ðŸ“—', 'ðŸ“˜', 'ðŸ“™', 'ðŸ“š', 'ðŸ“–'];
            const count = 20;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const book = document.createElement('div');
                    book.className = 'floating-book';
                    book.textContent = bookEmojis[Math.floor(Math.random() * bookEmojis.length)];
                    book.style.left = Math.random() * 100 + '%';
                    book.style.bottom = '-50px';
                    
                    const duration = Math.random() * 1 + 1;
                    book.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(book);
                    setTimeout(() => book.remove(), duration * 1000);
                }, i * 60);
            }
        }

        // Thought Bubbles Effect for Thoughts section
        function createThoughtBubbles() {
            const count = 15;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const bubble = document.createElement('div');
                    bubble.className = 'thought-bubble';
                    const size = Math.random() * 40 + 20;
                    bubble.style.width = size + 'px';
                    bubble.style.height = size + 'px';
                    bubble.style.left = Math.random() * 100 + '%';
                    bubble.style.bottom = '-50px';
                    
                    const duration = Math.random() * 0.7 + 0.8;
                    bubble.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(bubble);
                    setTimeout(() => bubble.remove(), duration * 1000);
                }, i * 80);
            }
        }

        // Floating Hearts Effect for Confessions section
        function createWhisperBubbles() {
            const whisperEmojis = ['ðŸ’¬', 'ðŸ—¨ï¸', 'ðŸ’­', 'ðŸ¤', 'ðŸ¤«'];
            const count = 25;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'floating-heart';
                    heart.textContent = whisperEmojis[Math.floor(Math.random() * whisperEmojis.length)];
                    heart.style.left = Math.random() * 100 + '%';
                    heart.style.bottom = '-50px';
                    
                    const duration = Math.random() * 1.2 + 1.5;
                    heart.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(heart);
                    setTimeout(() => heart.remove(), duration * 1000);
                }, i * 60);
            }
        }

        // Lightning Bolts Effect for Controversy section
        function createLightningBolts() {
            const count = 18;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const lightning = document.createElement('div');
                    lightning.className = 'floating-lightning';
                    lightning.textContent = 'âš¡';
                    lightning.style.left = Math.random() * 100 + '%';
                    lightning.style.top = '-50px';
                    
                    const duration = Math.random() * 0.6 + 0.9;
                    lightning.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(lightning);
                    setTimeout(() => lightning.remove(), duration * 1000);
                }, i * 70);
            }
        }

        // 3D tilt effect on hover
        function addTiltEffect() {
            return;
        }

        // Calculate time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        function toggleReplies(messageId, event) {
            if (event) event.stopPropagation();
            const repliesDiv = document.getElementById(`replies-${messageId}`);
            const card = repliesDiv ? repliesDiv.closest('.message-card') : null;

            if (!repliesDiv) return;

            if (repliesDiv.classList.contains('expanded')) {
                repliesDiv.classList.remove('expanded');
                if (card) card.classList.remove('expanded-card');
                setTimeout(() => {
                    repliesDiv.style.display = 'none';
                }, 200);
                return;
            }

            repliesDiv.style.display = 'block';
            requestAnimationFrame(() => repliesDiv.classList.add('expanded'));
            if (card) card.classList.add('expanded-card');

            const input = document.getElementById(`reply-input-${messageId}`);
            if (input) {
                setTimeout(() => input.focus(), 120);
            }
        }

        async function submitReply(messageId) {
            const input = document.getElementById(`reply-input-${messageId}`);
            if (!input) return;

            const text = input.value.trim();
            if (!text) {
                input.focus();
                return;
            }

            const profile = getUserProfile();

            try {
                const response = await fetch(`/api/messages/${messageId}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        username: profile.username,
                        avatar: profile.avatar
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.error || 'Failed to post reply');
                    return;
                }

                const updatedReply = await response.json();
                const msgIndex = allMessages.findIndex(m => m.id === messageId);
                if (msgIndex !== -1) {
                    if (!allMessages[msgIndex].replies) allMessages[msgIndex].replies = [];
                    allMessages[msgIndex].replies.push(updatedReply);
                }

                input.value = '';
                displayMessages(allMessages);

                setTimeout(() => {
                    const reopened = document.getElementById(`replies-${messageId}`);
                    const card = reopened ? reopened.closest('.message-card') : null;
                    if (reopened) {
                        reopened.style.display = 'block';
                        reopened.classList.add('expanded');
                    }
                    if (card) card.classList.add('expanded-card');
                }, 0);
            } catch (error) {
                console.error('Error posting reply:', error);
                alert('Error posting reply');
            }
        }

        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imageSrc;
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('postModal');
            if (event.target === modal) {
                toggleModal();
            }
        };

        // Allow posting with Ctrl+Enter
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                postMessage();
            }
        });

        // Delete message
        async function deleteMessage(messageId) {
            if (!adminSessionId) {
                alert('Admin login required to delete messages');
                toggleAdminModal();
                return;
            }
            
            if (!confirm('Delete this message?')) return;
            
            try {
                const response = await fetch(`/api/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });

                if (response.ok) {
                    loadMessages();
                } else if (response.status === 403) {
                    alert('Unauthorized. Please login as admin.');
                    adminSessionId = null;
                    localStorage.removeItem('adminSessionId');
                    checkAdminStatus();
                    toggleAdminModal();
                } else {
                    alert('Error deleting message. Please try again.');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            }
        }

        // Custom Cursor (optimized with RAF)
        const cursorDot = document.querySelector('.cursor-dot');
        let mouseX = 0, mouseY = 0;

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            cursorDot.style.left = mouseX + 'px';
            cursorDot.style.top = mouseY + 'px';
        });

        // Draggable message cards (optimized)
        let isDragging = false;
        let draggedCard = null;
        let offsetX = 0;
        let offsetY = 0;

        function makeDraggable(card) {
            card.addEventListener('mousedown', startDrag);
        }

        function startDrag(e) {
            const interactiveSelector = 'a, button, input, textarea, select, label, .reply-input-container, .replies-wrapper';
            if (e.target.closest(interactiveSelector)) return;
            
            isDragging = true;
            draggedCard = e.currentTarget;
            draggedCard.classList.add('dragging');
            
            const rect = draggedCard.getBoundingClientRect();
            const container = document.getElementById('messagesList').getBoundingClientRect();
            
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            e.preventDefault();
        }

        function onMouseMove(e) {
            if (!isDragging || !draggedCard) return;
            
            const container = document.getElementById('messagesList');
            const containerRect = container.getBoundingClientRect();
            
            let newX = e.clientX - containerRect.left - offsetX;
            let newY = e.clientY - containerRect.top - offsetY;
            
            // Keep within container bounds
            newX = Math.max(0, Math.min(newX, containerRect.width - draggedCard.offsetWidth));
            newY = Math.max(0, Math.min(newY, containerRect.height - draggedCard.offsetHeight));
            
            draggedCard.style.left = newX + 'px';
            draggedCard.style.top = newY + 'px';
        }

        function onMouseUp() {
            if (isDragging && draggedCard) {
                draggedCard.classList.remove('dragging');
                isDragging = false;
                draggedCard = null;
            }
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);

        // Like/Unlike functionality
        let likedMessages = JSON.parse(localStorage.getItem('likedMessages') || '[]');

        async function toggleLike(messageId, event) {
            event.stopPropagation();
            const isLiked = likedMessages.includes(messageId);
            
            try {
                const endpoint = isLiked ? 'unlike' : 'like';
                const response = await fetch(`/api/messages/${messageId}/${endpoint}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update localStorage
                    if (isLiked) {
                        likedMessages = likedMessages.filter(id => id !== messageId);
                    } else {
                        likedMessages.push(messageId);
                    }
                    localStorage.setItem('likedMessages', JSON.stringify(likedMessages));
                    
                    // Update UI
                    const likeBtn = event.target.closest('.like-btn');
                    const countSpan = likeBtn.querySelector('.like-count');
                    const heartSpan = likeBtn.querySelector('.heart-icon');
                    countSpan.textContent = data.likes;
                    likeBtn.classList.toggle('liked', !isLiked);
                    if (heartSpan) {
                        heartSpan.textContent = getLikeHeartIcon(!isLiked);
                    }
                    
                    // Animate
                    likeBtn.style.transform = 'scale(1.2)';
                    setTimeout(() => likeBtn.style.transform = '', 200);
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        // Report functionality
        let currentReportMessageId = null;

        function openReportModal(messageId, event) {
            event.stopPropagation();
            currentReportMessageId = messageId;
            document.getElementById('reportModal').classList.add('show');
            document.getElementById('reportReason').value = '';
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
            currentReportMessageId = null;
        }

        async function submitReport() {
            const reason = document.getElementById('reportReason').value;
            
            if (!reason) {
                alert('Please select a reason for reporting');
                return;
            }
            
            try {
                const response = await fetch(`/api/messages/${currentReportMessageId}/report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    closeReportModal();
                    showToast('Report submitted. Thank you.', 'success');
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                showToast('Error submitting report', 'error');
            }
        }

        // Search/Filter functionality
        let searchQuery = '';
        let allMessages = [];

        function filterMessages() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            displayMessages(allMessages);
        }

        // Update message counts
        async function updateMessageCounts() {
            // Counts removed - function kept for compatibility
            return;
        }

        // Share message as image
        async function shareMessage(messageId, event) {
            event.stopPropagation();
            
            const card = event.target.closest('.message-card');
            const shareBtn = card.querySelector('.share-btn');
            
            // Use modern Web Share API if available
            if (navigator.share) {
                try {
                    const message = allMessages.find(m => m.id === messageId);
                    await navigator.share({
                        title: 'Stickly Message',
                        text: message.text || 'Check out this message!',
                        url: window.location.href
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Error sharing:', error);
                    }
                }
            } else {
                // Fallback: Copy to clipboard
                const message = allMessages.find(m => m.id === messageId);
                const text = `${message.text}\n\n- Shared from Stickly`;
                
                navigator.clipboard.writeText(text).then(() => {
                    shareBtn.innerHTML = 'âœ“';
                    showToast('Copied to clipboard', 'success');
                    setTimeout(() => shareBtn.innerHTML = 'ðŸ”—', 1500);
                }).catch(err => {
                    console.error('Error copying:', err);
                    showToast('Share failed. Please try again.', 'error');
                });
            }
        }


    </script>
</body>
</html>
