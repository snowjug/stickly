<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stickly - Share Your Thoughts Anonymously</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Custom Cursor -->
    <div class="cursor-dot"></div>
    <div class="cursor-shadow"></div>
    
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo">üí¨</span>
            <div>
                <h1>Stickly</h1>
                <p class="tagline">Your secrets are safe here</p>
            </div>
        </div>
        <div class="nav-links">
            <button class="nav-btn active" data-section="all" onclick="switchSection('all')">All</button>
            <button class="nav-btn" data-section="whistleblower" onclick="switchSection('whistleblower')">üîì Whistleblower</button>
            <button class="nav-btn" data-section="inspiration" onclick="switchSection('inspiration')">Inspiration</button>
            <button class="nav-btn" data-section="knowledge" onclick="switchSection('knowledge')">Knowledge</button>
            <button class="nav-btn" data-section="thoughts" onclick="switchSection('thoughts')">Thoughts</button>
            <button class="nav-btn" data-section="confessions" onclick="switchSection('confessions')">Confessions</button>
        </div>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">
            <span id="darkModeIcon">üåô</span>
        </button>
        <button class="admin-toggle" id="adminBtn" onclick="toggleAdminModal()" title="Admin login">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        </button>
    </nav>

    <!-- Floating Action Button -->
    <button class="fab" onclick="toggleModal()">
        <span class="fab-icon">+</span>
        <span class="fab-label">Post</span>
    </button>

    <!-- Post Message Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share a Message</h2>
                <button class="close-btn" onclick="toggleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="category-selector">
                    <label>Choose a category:</label>
                    <div class="category-buttons">
                        <button class="category-btn" data-category="whistleblower" onclick="selectCategory('whistleblower')">
                            <span class="emoji">üîì</span>
                            <span>Whistleblower</span>
                        </button>
                        <button class="category-btn" data-category="inspiration" onclick="selectCategory('inspiration')">
                            <span class="emoji">‚ú®</span>
                            <span>Inspiration</span>
                        </button>
                        <button class="category-btn" data-category="knowledge" onclick="selectCategory('knowledge')">
                            <span class="emoji">üìö</span>
                            <span>Knowledge</span>
                        </button>
                        <button class="category-btn active" data-category="thoughts" onclick="selectCategory('thoughts')">
                            <span class="emoji">üí≠</span>
                            <span>Thoughts</span>
                        </button>
                        <button class="category-btn" data-category="confessions" onclick="selectCategory('confessions')">
                            <span class="emoji">ü§´</span>
                            <span>Confessions</span>
                        </button>
                    </div>
                </div>
                <textarea 
                    id="messageInput" 
                    placeholder="What's on your mind?"
                    maxlength="500"
                ></textarea>
                <div class="image-upload-section">
                    <label for="imageUpload" class="image-upload-label">
                        <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                        </svg>
                        <span class="upload-text">Attach Image or GIF</span>
                    </label>
                    <input 
                        type="file" 
                        id="imageUpload" 
                        accept="image/jpeg,image/jpg,image/gif,image/png"
                        style="display: none;"
                    />
                    <div style="text-align: center; margin: 0.5rem 0; color: var(--subtle-text-color); font-size: 0.9rem;">or</div>
                    <input 
                        type="url" 
                        id="imageUrl" 
                        placeholder="Paste image/GIF URL"
                        class="admin-input"
                        style="margin-bottom: 0.5rem;"
                    />
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                <div class="form-footer">
                    <span class="char-count">0/500</span>
                    <button class="post-btn" onclick="postMessage()">Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="adminModalTitle">Admin Login</h2>
                <button class="close-btn" onclick="toggleAdminModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="adminLoginForm">
                    <input 
                        type="text" 
                        id="adminUsername" 
                        placeholder="Username"
                        class="admin-input"
                    />
                    <input 
                        type="password" 
                        id="adminPassword" 
                        placeholder="Password"
                        class="admin-input"
                    />
                    <button class="post-btn" onclick="adminLogin()" style="width: 100%; margin-top: 1rem;">Login</button>
                </div>
                <div id="adminPanel" style="display: none;">
                    <p style="text-align: center; color: var(--text-color); margin-bottom: 1rem;">‚úÖ Logged in as Admin</p>
                    <button class="post-btn" onclick="adminLogout()" style="width: 100%; background: #ff4444;">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="main-container">
        <div class="section-header">
            <h2 id="sectionTitle">All Messages</h2>
            <p id="sectionSubtitle">Anonymous messages from around the world</p>
        </div>
        <div id="messagesList"></div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="" alt="Full size image">
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Made with racism by Atharv & Ankit</p>
    </footer>

    <script>
        let currentSection = 'all';
        let selectedCategory = 'thoughts';
        let adminSessionId = localStorage.getItem('adminSessionId') || null;

        // Admin functions
        function toggleAdminModal() {
            const modal = document.getElementById('adminModal');
            modal.classList.toggle('show');
            checkAdminStatus();
        }

        async function checkAdminStatus() {
            const adminBtn = document.getElementById('adminBtn');
            const loginForm = document.getElementById('adminLoginForm');
            const adminPanel = document.getElementById('adminPanel');
            
            if (!adminSessionId) {
                adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
                loginForm.style.display = 'block';
                adminPanel.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/api/admin/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });
                const data = await response.json();
                
                if (data.isAdmin) {
                    adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>';
                    adminBtn.style.background = 'linear-gradient(135deg, #0071e3, #0077ed)';
                    adminBtn.style.color = 'white';
                    loginForm.style.display = 'none';
                    adminPanel.style.display = 'block';
                } else {
                    adminSessionId = null;
                    localStorage.removeItem('adminSessionId');
                    adminBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
                    adminBtn.style.background = '';
                    adminBtn.style.color = '';
                    loginForm.style.display = 'block';
                    adminPanel.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    adminSessionId = data.sessionId;
                    localStorage.setItem('adminSessionId', adminSessionId);
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminPassword').value = '';
                    toggleAdminModal();
                    checkAdminStatus();
                    loadMessages();
                } else {
                    alert('Invalid credentials');
                }
            } catch (error) {
                console.error('Error logging in:', error);
                alert('Error logging in');
            }
        }

        async function adminLogout() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });
                
                adminSessionId = null;
                localStorage.removeItem('adminSessionId');
                toggleAdminModal();
                checkAdminStatus();
                loadMessages();
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Image upload preview
        function initImageUpload() {
            const imageUpload = document.getElementById('imageUpload');
            const imageUrl = document.getElementById('imageUrl');
            const imagePreview = document.getElementById('imagePreview');
            
            if (!imageUpload) return;
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('Image selected:', file.name, file.type);
                    imageUrl.value = ''; // Clear URL input
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.innerHTML = `
                            <div class="preview-container">
                                <img src="${e.target.result}" alt="Preview" />
                                <button class="remove-image" onclick="removeImage()">√ó</button>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle URL input
            if (imageUrl) {
                imageUrl.addEventListener('input', (e) => {
                    const url = e.target.value.trim();
                    if (url) {
                        imageUpload.value = ''; // Clear file upload
                        imagePreview.innerHTML = `
                            <div class="preview-container">
                                <img src="${url}" alt="Preview" onerror="this.parentElement.innerHTML='<p style=\"color: var(--subtle-text-color); text-align: center;\">Invalid image URL</p>';" />
                                <button class="remove-image" onclick="removeImage()">√ó</button>
                            </div>
                        `;
                    } else {
                        imagePreview.innerHTML = '';
                    }
                });
            }
        }

        function removeImage() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('imageUrl').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }

        // Load messages when page loads
        window.onload = () => {
            loadMessages();
            updateCharCount();
            initDarkMode();
            initFAB();
            initImageUpload();
            checkAdminStatus();
        };

        // FAB collapse functionality
        function initFAB() {
            const fab = document.querySelector('.fab');
            let timeout;

            // Auto-collapse after 3 seconds
            timeout = setTimeout(() => {
                fab.classList.add('collapsed');
            }, 3000);

            // Expand on hover
            fab.addEventListener('mouseenter', () => {
                clearTimeout(timeout);
                fab.classList.remove('collapsed');
            });

            // Collapse after leaving
            fab.addEventListener('mouseleave', () => {
                timeout = setTimeout(() => {
                    fab.classList.add('collapsed');
                }, 1000);
            });
        }

        // Dark mode functionality
        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Update character count
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', updateCharCount);

        function updateCharCount() {
            const count = messageInput.value.length;
            document.querySelector('.char-count').textContent = `${count}/500`;
        }

        // Switch section
        function switchSection(section) {
            currentSection = section;
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === section);
            });

            const titles = {
                'all': { title: 'All Messages', subtitle: 'Anonymous messages from around the world' },
                'whistleblower': { title: 'Whistleblower', subtitle: 'Reveal the truth - Expose scams, corruption, and company secrets' },
                'inspiration': { title: 'Inspiration', subtitle: 'Find a spark of motivation' },
                'knowledge': { title: 'Knowledge', subtitle: 'Learn something new today' },
                'thoughts': { title: 'Thoughts', subtitle: 'Random thoughts and musings' },
                'confessions': { title: 'Confessions', subtitle: 'Anonymous secrets and stories' }
            };

            document.getElementById('sectionTitle').textContent = titles[section].title;
            document.getElementById('sectionSubtitle').textContent = titles[section].subtitle;

            // Trigger section-specific effects
            if (section === 'whistleblower') {
                createMatrixRain();
            } else if (section === 'inspiration') {
                createSparkles();
            } else if (section === 'knowledge') {
                createFloatingBooks();
            } else if (section === 'thoughts') {
                createThoughtBubbles();
            } else if (section === 'confessions') {
                createFloatingHearts();
            }

            loadMessages();
        }

        // Toggle modal
        function toggleModal() {
            const modal = document.getElementById('postModal');
            const isClosing = modal.classList.contains('show');
            
            if (isClosing) {
                // Clear inputs when closing modal
                messageInput.value = '';
                const imageUpload = document.getElementById('imageUpload');
                const imageUrl = document.getElementById('imageUrl');
                if (imageUpload) {
                    imageUpload.value = '';
                    imageUrl.value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                }
                updateCharCount();
            }
            
            modal.classList.toggle('show');
        }

        // Select category
        function selectCategory(category) {
            selectedCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
        }

        // Load messages
        async function loadMessages() {
            try {
                const url = currentSection === 'all' 
                    ? '/api/messages' 
                    : `/api/messages?category=${currentSection}`;
                
                const response = await fetch(url);
                const messages = await response.json();
                displayMessages(messages);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Post a new message
        async function postMessage() {
            const messageText = messageInput.value.trim();
            const imageUpload = document.getElementById('imageUpload');
            const imageUrl = document.getElementById('imageUrl');
            const modalContent = document.querySelector('.modal-content');
            
            // Allow posting if either message, file, or URL is present
            if (!messageText && (!imageUpload || !imageUpload.files[0]) && (!imageUrl || !imageUrl.value.trim())) {
                modalContent.classList.add('shake');
                setTimeout(() => modalContent.classList.remove('shake'), 400);
                return;
            }

            try {
                const formData = new FormData();
                formData.append('message', messageText || '');
                formData.append('category', selectedCategory);
                
                if (imageUpload && imageUpload.files[0]) {
                    console.log('Uploading image:', imageUpload.files[0].name);
                    formData.append('image', imageUpload.files[0]);
                } else if (imageUrl && imageUrl.value.trim()) {
                    console.log('Using image URL:', imageUrl.value.trim());
                    formData.append('imageUrl', imageUrl.value.trim());
                }

                const response = await fetch('/api/messages', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Message posted successfully:', result);
                    messageInput.value = '';
                    if (imageUpload) {
                        imageUpload.value = '';
                        imageUrl.value = '';
                        document.getElementById('imagePreview').innerHTML = '';
                    }
                    updateCharCount();
                    toggleModal();
                    createConfetti();
                    loadMessages();
                } else {
                    const error = await response.json();
                    console.error('Error response:', error);
                    alert('Error posting message. Please try again.');
                }
            } catch (error) {
                console.error('Error posting message:', error);
                alert('Error posting message. Please try again.');
            }
        }

        // Display messages as cards
        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                messagesList.innerHTML = '<div class="no-messages">No messages in this category yet. Be the first to share!</div>';
                return;
            }

            const containerWidth = messagesList.offsetWidth || 1200;
            const cardWidth = 300;
            const gap = 40;
            const cardsPerRow = Math.floor(containerWidth / (cardWidth + gap));

            const categoryEmojis = {
                'whistleblower': 'üîì',
                'inspiration': '‚ú®',
                'knowledge': 'üìö',
                'thoughts': 'üí≠',
                'confessions': 'ü§´'
            };

            const fragment = document.createDocumentFragment();
            const totalRows = Math.ceil(messages.length / cardsPerRow);

            messages.forEach((msg, index) => {
                const timeAgo = getTimeAgo(new Date(msg.timestamp));
                const row = Math.floor(index / cardsPerRow);
                const col = index % cardsPerRow;
                const left = col * (cardWidth + gap);
                const top = row * (cardWidth + gap);

                const card = document.createElement('div');
                card.className = 'message-card';
                card.setAttribute('data-category', msg.category);
                card.style.cssText = `left: ${left}px; top: ${top}px; animation-delay: ${index * 0.05}s; width: ${cardWidth}px;`;
                
                card.innerHTML = `
                    <div class="message-header">
                        <span class="category-badge">${categoryEmojis[msg.category]} ${msg.category}</span>
                        <div class="message-actions">
                            <span class="message-time">${timeAgo}</span>
                            <button class="delete-btn" onclick="deleteMessage(${msg.id})" title="Delete message">√ó</button>
                        </div>
                    </div>
                    <p class="message-text">${escapeHtml(msg.text)}</p>
                    ${msg.image ? `<img src="${msg.image}" alt="Attached image" class="message-image" onclick="openImageModal('${msg.image}')" />` : ''}
                `;
                
                fragment.appendChild(card);
            });

            messagesList.innerHTML = '';
            messagesList.appendChild(fragment);
            messagesList.style.minHeight = (totalRows * (cardWidth + gap)) + 'px';

            // Add effects
            addTiltEffect();
            document.querySelectorAll('.message-card').forEach(makeDraggable);
        }

        // Confetti animation
        function createConfetti() {
            const colors = ['#FF6B6B', '#4ECDC4', '#95E1D3', '#F38181', '#FFD93D', '#6BCF7F'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = (Math.random() * 10 + 5) + 'px';
                    confetti.style.opacity = '1';
                    confetti.style.animation = `confetti-fall ${Math.random() * 2 + 2}s linear forwards`;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        // Matrix Rain Effect for Whistleblower section
        function createMatrixRain() {
            const chars = '01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
            const drops = 30;
            
            for (let i = 0; i < drops; i++) {
                setTimeout(() => {
                    const matrixChar = document.createElement('div');
                    matrixChar.className = 'matrix-char';
                    matrixChar.textContent = chars[Math.floor(Math.random() * chars.length)];
                    matrixChar.style.left = Math.random() * 100 + '%';
                    matrixChar.style.top = '-20px';
                    
                    const duration = Math.random() * 2 + 3; // 3-5 seconds
                    matrixChar.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(matrixChar);
                    
                    // Remove after animation
                    setTimeout(() => matrixChar.remove(), duration * 1000);
                }, i * 50);
            }
        }

        // Sparkles Effect for Inspiration section
        function createSparkles() {
            const sparkleChars = ['‚ú®', '‚≠ê', 'üí´', 'üåü', '‚ú¥Ô∏è'];
            const count = 25;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.textContent = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.top = Math.random() * 100 + '%';
                    sparkle.style.fontSize = (Math.random() * 20 + 15) + 'px';
                    
                    const duration = Math.random() * 2 + 2;
                    sparkle.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), duration * 1000);
                }, i * 40);
            }
        }

        // Floating Books Effect for Knowledge section
        function createFloatingBooks() {
            const bookEmojis = ['üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ'];
            const count = 20;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const book = document.createElement('div');
                    book.className = 'floating-book';
                    book.textContent = bookEmojis[Math.floor(Math.random() * bookEmojis.length)];
                    book.style.left = Math.random() * 100 + '%';
                    book.style.bottom = '-50px';
                    
                    const duration = Math.random() * 3 + 4;
                    book.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(book);
                    setTimeout(() => book.remove(), duration * 1000);
                }, i * 60);
            }
        }

        // Thought Bubbles Effect for Thoughts section
        function createThoughtBubbles() {
            const count = 15;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const bubble = document.createElement('div');
                    bubble.className = 'thought-bubble';
                    const size = Math.random() * 40 + 20;
                    bubble.style.width = size + 'px';
                    bubble.style.height = size + 'px';
                    bubble.style.left = Math.random() * 100 + '%';
                    bubble.style.bottom = '-50px';
                    
                    const duration = Math.random() * 3 + 3;
                    bubble.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(bubble);
                    setTimeout(() => bubble.remove(), duration * 1000);
                }, i * 80);
            }
        }

        // Floating Hearts Effect for Confessions section
        function createFloatingHearts() {
            const heartEmojis = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíì', 'üíù'];
            const count = 20;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'floating-heart';
                    heart.textContent = heartEmojis[Math.floor(Math.random() * heartEmojis.length)];
                    heart.style.left = Math.random() * 100 + '%';
                    heart.style.bottom = '-50px';
                    
                    const duration = Math.random() * 2 + 3;
                    heart.style.animationDuration = duration + 's';
                    
                    document.body.appendChild(heart);
                    setTimeout(() => heart.remove(), duration * 1000);
                }, i * 50);
            }
        }

        // 3D tilt effect on hover
        function addTiltEffect() {
            const cards = document.querySelectorAll('.message-card');
            
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const rotateX = (y - centerY) / 10;
                    const rotateY = (centerX - x) / 10;
                    
                    card.style.setProperty('--rotate-x', `${rotateX}deg`);
                    card.style.setProperty('--rotate-y', `${rotateY}deg`);
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.setProperty('--rotate-x', '0deg');
                    card.style.setProperty('--rotate-y', '0deg');
                });
            });
        }

        // Calculate time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imageSrc;
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imageSrc;
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('postModal');
            if (event.target === modal) {
                toggleModal();
            }
        };

        // Allow posting with Ctrl+Enter
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                postMessage();
            }
        });

        // Delete message
        async function deleteMessage(messageId) {
            if (!adminSessionId) {
                alert('Admin login required to delete messages');
                toggleAdminModal();
                return;
            }
            
            if (!confirm('Delete this message?')) return;
            
            try {
                const response = await fetch(`/api/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: adminSessionId })
                });

                if (response.ok) {
                    loadMessages();
                } else if (response.status === 403) {
                    alert('Unauthorized. Please login as admin.');
                    adminSessionId = null;
                    localStorage.removeItem('adminSessionId');
                    checkAdminStatus();
                    toggleAdminModal();
                } else {
                    alert('Error deleting message. Please try again.');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            }
        }

        // Custom Cursor (optimized with RAF)
        const cursorDot = document.querySelector('.cursor-dot');
        let mouseX = 0, mouseY = 0;

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            cursorDot.style.left = mouseX + 'px';
            cursorDot.style.top = mouseY + 'px';
        });

        // Draggable message cards (optimized)
        let isDragging = false;
        let draggedCard = null;
        let offsetX = 0;
        let offsetY = 0;

        function makeDraggable(card) {
            card.addEventListener('mousedown', startDrag);
        }

        function startDrag(e) {
            if (e.target.tagName === 'A' || e.target.closest('a')) return;
            
            isDragging = true;
            draggedCard = e.currentTarget;
            draggedCard.classList.add('dragging');
            
            const rect = draggedCard.getBoundingClientRect();
            const container = document.getElementById('messagesList').getBoundingClientRect();
            
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            e.preventDefault();
        }

        function onMouseMove(e) {
            if (!isDragging || !draggedCard) return;
            
            const container = document.getElementById('messagesList');
            const containerRect = container.getBoundingClientRect();
            
            let newX = e.clientX - containerRect.left - offsetX;
            let newY = e.clientY - containerRect.top - offsetY;
            
            // Keep within container bounds
            newX = Math.max(0, Math.min(newX, containerRect.width - draggedCard.offsetWidth));
            newY = Math.max(0, Math.min(newY, containerRect.height - draggedCard.offsetHeight));
            
            draggedCard.style.left = newX + 'px';
            draggedCard.style.top = newY + 'px';
        }

        function onMouseUp() {
            if (isDragging && draggedCard) {
                draggedCard.classList.remove('dragging');
                isDragging = false;
                draggedCard = null;
            }
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    </script>
</body>
</html>
